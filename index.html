<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Battaglia Royale</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }
        .bg-arena {
            background-image: linear-gradient(rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0.8)), url('https://i.pinimg.com/originals/a3/6c/13/a36c136f7530636c859981881e2c1c38.jpg');
            background-size: cover;
            background-position: center;
        }
        .character-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out, border-color 0.2s ease-in-out;
            border: 2px solid transparent;
        }
        .character-card.selectable:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.8);
            border-color: #3b82f6;
        }
        .character-card.taken {
            filter: grayscale(100%) brightness(0.5);
            cursor: not-allowed;
        }
        .character-icon.defeated {
            filter: grayscale(100%);
            opacity: 0.6;
        }
        .btn-glow {
            transition: all 0.2s ease-in-out;
        }
        .btn-glow:hover:not(:disabled) {
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.7);
        }
        .turn-highlight {
            animation: pulse-border 2s infinite;
            border: 2px solid #fBBF24;
        }
        @keyframes pulse-border {
            0% { box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(251, 191, 36, 0); }
            100% { box-shadow: 0 0 0 0 rgba(251, 191, 36, 0); }
        }
        .fighting-team {
             animation: pulse-fight 1.5s infinite;
        }
        @keyframes pulse-fight {
            0%, 100% { transform: scale(1); box-shadow: 0 0 20px #facc15; }
            50% { transform: scale(1.03); box-shadow: 0 0 35px #fde047; }
        }
        .color-swatch {
            transition: transform 0.2s;
        }
        .color-swatch:hover {
            transform: scale(1.1);
        }
        .color-swatch.selected {
            border: 3px solid white;
            transform: scale(1.1);
        }
        .color-swatch.taken {
            filter: grayscale(100%);
            cursor: not-allowed;
            opacity: 0.5;
        }
        .dice {
            animation: roll 0.5s ease-out;
        }
        @keyframes roll {
            0% { transform: rotate(0deg) scale(1.2); }
            100% { transform: rotate(360deg) scale(1); }
        }
        .fade-in { animation: fadeIn 1s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .hp-bar-inner { transition: width 0.5s ease-in-out, background-color 0.5s ease-in-out; }
        .damage-text {
            animation: damage-pop 0.8s ease-out forwards;
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 2.5rem;
            font-weight: 900;
            color: #ef4444;
            text-shadow: 0 0 5px white;
        }
        @keyframes damage-pop {
            0% { transform: translate(-50%, 0) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -100px) scale(1.5); opacity: 0; }
        }
        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: white;
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <div id="app" class="min-h-screen w-full flex items-center justify-center p-4">
        <!-- L'applicazione verrà renderizzata qui da JavaScript -->
    </div>
    <div id="tooltip" class="hidden fixed bg-black bg-opacity-80 text-white p-2 rounded-lg text-sm z-50 pointer-events-none"></div>
    <div id="host-controls-container"></div>


    <script type="module">
        // Importazione dei moduli di Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc, deleteDoc, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURAZIONE FIREBASE ---
        const firebaseConfig = {
         apiKey: "AIzaSyDrBs4Yjc_76_1AdHm51Tlib5PaktoMxjw",
         authDomain: "battle-royale-cartoon.firebaseapp.com",
         projectId: "battle-royale-cartoon",
         storageBucket: "battle-royale-cartoon.firebasestorage.app",
         messagingSenderId: "1078110088589",
         appId: "1:1078110088589:web:9ddb41a59979e094bbe1c4",
         measurementId: "G-CD1D1Z3Z6J"
        };
        const appId = "battle-royale-cartoon";

        // Inizializzazione di Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- DATABASE PERSONAGGI (CON STATUS EFFECTS) ---
        let charactersDB = [
            { id: 71, name: "Aang", img: "https://i.pinimg.com/736x/05/01/fc/0501fc8ed44f7bd4ad9e74d9bb959669.jpg", stats: { hp: 88, atk: 10, def: 8, spd: 11 }, moves: [{name: "Dominio dell'Aria", power: 1.7, description: "Un potente colpo di vento potenziato."}, {name: "Stato dell'Avatar", power: 2.2, description: "Scatena il potere di tutti gli Avatar potenziato."}, {name: "Vento Stordente", power: 0, effect: 'stun', effectDuration: [2, 2], uses: 2, description: "Stunna per 2 turni."}] },
            { id: 2, name: "Androide 18", img: "https://i.pinimg.com/736x/4c/68/ff/4c68ffd02e2220ec0b92f169f95d2e9f.jpg", stats: { hp: 90, atk: 10, def: 9, spd: 9 }, moves: [{name: "Infinity Bullet", power: 1.1, description: "Una raffica di colpi energetici."}, {name: "Power Blitz", power: 1.4, description: "Un'onda di energia concentrata."}, {name: "Barriera Energetica", power: 0, effect: 'invulnerability', effectDuration: [2, 2], uses: 3, description: "Diventa invulnerabile per 2 turni."}] },
            { id: 49, name: "Ariel", img: "https://i.pinimg.com/736x/fe/a4/2e/fea42ebd0c67f19d1c0df8fe7a9c6613.jpg", stats: { hp: 80, atk: 8, def: 7, spd: 8 }, moves: [{name: "Canto Incantatore", power: 1.0, effect: 'stun', effectChance: 0.5, effectDuration: [2,2], uses: 4, description: "Una melodia che può bloccare il nemico per due turni."}, {name: "Colpo di Coda", power: 1.2, description: "Un potente colpo con la sua coda."}, {name: "Curiosità", power: 0, effect: 'stat_up', description: "Trova un oggetto che la potenzia."}] },
            { id: 19, name: "Barbie", img: "https://i.pinimg.com/1200x/bd/e7/29/bde7296be641d72842be35b84065b48f.jpg", stats: { hp: 78, atk: 7, def: 7, spd: 9 }, moves: [{name: "Cambio d'Abito", power: 0, effect: 'stat_up', description: "Cambia stile per aumentare le statistiche."}, {name: "Discorso Ispiratore", power: 0, effect: 'team_atk_up', description: "Ispira la squadra aumentando l'attacco."}, {name: "Attacco Scintillante", power: 1.1, description: "Un attacco abbagliante."}] },
            { id: 86, name: "Bender", img: "https://i.pinimg.com/736x/17/e2/65/17e2654def74fcc7137d202fb48f7c9a.jpg", stats: { hp: 95, atk: 11, def: 11, spd: 4 }, moves: [{name: "Bending", power: 1.3, description: "Piega una trave d'acciaio sull'avversario."}, {name: "Alito di Fuoco Alcolico", power: 1.4, effect: 'burn', effectChance: 0.5, effectDuration: [3, 4], effectDamage: [4, 7], description: "Un rutto infuocato che può scottare il nemico."}, {name: "Mordimi il posteriore!", power: 1.0, effect: 'def_down', description: "Un insulto che diminuisce la difesa nemica."}] },
            { id: 39, name: "Ben 10 (teen)", img: "https://i.pinimg.com/736x/ad/5c/cd/ad5ccdba073abda30c152f7eac48447b.jpg", stats: { hp: 90, atk: 10, def: 9, spd: 9 }, moves: [{name: "Trasformazione Aliena", power: 1.5, description: "Si trasforma in un alieno per un attacco a sorpresa."}, {name: "Vulkanus", power: 0, damage: [14, 14], effect: 'burn', effectChance: 1.0, effectDuration: [3, 4], description: "Lancia un getto di magma che infligge 14 danni e brucia il nemico."}, {name: "Potere Omnitrix", power: 0, effect: 'freeze', effectChance: 1.0, effectDuration: [3, 3], uses: 3, description: "Congela il nemico per 3 turni."}] },
            { id: 20, name: "Bloom", img: "https://i.pinimg.com/736x/2a/0e/3d/2a0e3d2c81ef601a4dc4647fe888b1a0.jpg", stats: { hp: 90, atk: 11, def: 8, spd: 9 }, moves: [{name: "Fiamma del Drago", power: 1.5, effect: 'burn', effectChance: 0.6, effectDuration: [3, 4], effectDamage: [5, 8], description: "Il potere supremo che può scottare gravemente."}, {name: "Scudo del Drago", power: 0, effect: 'invulnerability', effectDuration: [2, 2], uses: 3, description: "Diventa invulnerabile per 2 turni."}, {name: "Essenza Vitale", power: 0, effect: 'heal', healAmount: [15, 20], uses: 4, description: "Cura le ferite con l'energia vitale."}] },
            { id: 18, name: "Bowser", img: "https://i.pinimg.com/1200x/cf/3f/ec/cf3fec1f6b9334e0255065f150fa97a9.jpg", stats: { hp: 110, atk: 12, def: 11, spd: 4 }, moves: [{name: "Alito di Fuoco", power: 1.4, effect: 'burn', effectChance: 0.4, effectDuration: [3, 4], effectDamage: [4, 6], description: "Una fiammata che può scottare il nemico."}, {name: "Guscio Rotante", power: 1.2, description: "Si ritira nel guscio e carica."}, {name: "Pugno Possente", power: 1.3, description: "Un pugno brutale e diretto."}] },
            { id: 37, name: "Brago", img: "https://i.pinimg.com/1200x/7f/28/31/7f283141b761fee05de62cd51f4926ee.jpg", stats: { hp: 98, atk: 12, def: 9, spd: 8 }, moves: [{name: "Reis", power: 1.2, description: "Una piccola sfera di gravità."}, {name: "Gravirei", power: 1.4, effect: 'spd_down', description: "Rallenta il nemico con la gravità."}, {name: "Gigano Reis", power: 1.7, description: "Una potente onda gravitazionale."}] },
            { id: 60, name: "Bugs Bunny", img: "https://i.pinimg.com/1200x/ff/d1/66/ffd166e976132eb05bf59b5339a01931.jpg", stats: { hp: 82, atk: 8, def: 8, spd: 9 }, moves: [{name: "Che succede, amico?", power: 1.0, effect: 'stun', effectChance: 0.4, effectDuration: [2,2], uses: 4, description: "Confondi il nemico con la tua astuzia, bloccandolo per due turni."}, {name: "Carote a Profusione", power: 0, damage: [9,9], hits: 5, description: "Colpisce 5 volte di fila per 9 danni ogni volta."}, {name: "Bacio a Sorpresa", power: 1.2, description: "Un bacio inaspettato che fa danni."}, {name: "Ritorno in Tana", power: 0, effect: 'heal', healAmount: [50, 50], uses: 2, description: "Si cura di 50 HP."}] },
            { id: 3, name: "Carlos Oliveira", img: "https://i.pinimg.com/736x/9c/d7/61/9cd7611ff4aaceecd802b75a2d2ad1f6.jpg", stats: { hp: 90, atk: 10, def: 7, spd: 7 }, moves: [{name: "Raffica di Fucile", power: 1.4, description: "Una serie di colpi precisi."}, {name: "Gancio Letale", power: 1.1, description: "Un attacco corpo a corpo."}, {name: "Kit Medico", power: 0, effect: 'heal', healAmount: [15, 20], uses: 4, description: "Recupera una buona quantità di HP."}, {name: "Petto Peloso", power: 0, damage: [20, 20], effect: 'stun', effectChance: 1.0, effectDuration: [2, 2], uses: 1, description: "Un attacco potente che stordisce il nemico (1 solo uso)."}] },
            { id: 55, name: "Chat Noir", img: "https://i.pinimg.com/736x/c3/ed/77/c3ed7755f4cbee4cd34316139d132597.jpg", stats: { hp: 85, atk: 10, def: 8, spd: 11 }, moves: [{name: "Bastone Estensibile", power: 1.3, description: "Colpisce da lontano con il suo bastone."}, {name: "Cataclisma", power: 1.8, description: "Un tocco distruttivo che infligge danni enormi."}, {name: "Visione Notturna", power: 0, effect: 'atk_up', description: "Aumenta la sua precisione e attacco."}] },
            { id: 69, name: "Chef Hatchet", img: "https://i.pinimg.com/1200x/4f/7c/8b/4f7c8bc30de9875dba940c17fcd6264a.jpg", stats: { hp: 95, atk: 10, def: 9, spd: 6 }, moves: [{name: "Cucchiaio di Legno", power: 1.3, description: "Un colpo doloroso con un cucchiaio gigante."}, {name: "Cibo Disgustoso", power: 1.0, effect: 'poison', effectChance: 1.0, effectDuration: [3, 4], effectDamage: [3, 5], description: "Lancia il suo cibo che avvelena il nemico."}, {name: "Addestramento Militare", power: 0, effect: 'stat_up', description: "Usa la sua esperienza per potenziarsi."}] },
            { id: 48, name: "Clarence", img: "https://i.pinimg.com/1200x/ed/50/84/ed5084c8f0cf0f3f7c9f60df18346c20.jpg", stats: { hp: 80, atk: 7, def: 7, spd: 6 }, moves: [{name: "Snack di Emergenza", power: 0, effect: 'special_heal', uses: 4, description: "Recupera HP in base allo snack: Pizza (30), Patatine (50% max HP), Ciambella (15)."}, {name: "Abbraccio Travolgente", power: 0, damage: [6, 10], description: "Un abbraccio così forte da fare 6-10 danni."}, {name: "Amici Ovunque", power: 0, damage: [4, 6], hits: 3, description: "Colpisce 3 volte di fila per 4-6 danni ogni volta."}] },
            { id: 23, name: "Corvina", img: "https://i.pinimg.com/736x/fc/e3/30/fce330b50ce9cbf53287e441be15d597.jpg", stats: { hp: 88, atk: 11, def: 7, spd: 8 }, moves: [{name: "Azarath Metrion Zinthos", power: 1.6, description: "Scatena la sua potente magia oscura."}, {name: "Scudo Oscuro", power: 0, effect: 'invulnerability', effectDuration: [2, 2], uses: 3, description: "Diventa invulnerabile per 2 turni."}, {name: "Levitazione", power: 0, effect: 'invulnerability', effectDuration: [2, 2], uses: 3, description: "Diventa invulnerabile per 2 turni."}] },
            { id: 97, name: "Cortana", img: "https://i.pinimg.com/736x/00/93/12/0093124294f30d296f6c6155485c300c.jpg", stats: { hp: 75, atk: 8, def: 8, spd: 11 }, moves: [{name: "Sovraccarico Logico", power: 1.6, description: "Un potente attacco dati che ignora parte della difesa."}, {name: "Disturbo Dati", power: 0, damage: [8, 8], effect: 'cleanse', description: "Infligge 8 danni al bersaglio e si cura da qualsiasi status."}, {name: "Protocollo di Ripristino", power: 0, effect: 'heal', healAmount: [40, 40], uses: 2, description: "Recupera 40 HP (max 2 usi)."}] },
            { id: 62, name: "Cosmo", img: "https://i.pinimg.com/736x/47/22/99/472299b4c669c052c662df1730403d83.jpg", stats: { hp: 80, atk: 8, def: 7, spd: 8 }, moves: [{name: "Magia del Sonno", power: 0, effect: 'sleep', effectChance: 1.0, effectDuration: [3, 3], uses: 3, description: "Addormenta il nemico per 3 turni (max 3 usi)."}, {name: "Magia Potente", power: 0, damage: [10, 18], description: "Infligge da 10 a 18 danni magici."}, {name: "Wanda?!", power: 0, effect: 'stun', effectChance: 1.0, effectDuration: [2, 2], uses: 3, description: "Stordisce il nemico per due turni (max 3 usi)."}] },
            { id: 25, name: "Cyborg", img: "https://i.pinimg.com/736x/bc/ef/b9/bcefb901b8a25aaf2716e142e9cf89a9.jpg", stats: { hp: 95, atk: 11, def: 10, spd: 6 }, moves: [{name: "Cannone Sonico", power: 1.5, description: "Spara un'onda sonica devastante."}, {name: "Pugno-Razzo", power: 1.3, description: "Lancia il suo pugno come un proiettile."}, {name: "Riparazione Automatica", power: 0, effect: 'heal', healAmount: [10, 20], uses: 4, description: "Attiva i protocolli di auto-riparazione."}] },
            { id: 61, name: "Daffy Duck", img: "https://i.pinimg.com/736x/be/a3/7e/bea37edf64883f0cebaa6899c9fbad71.jpg", stats: { hp: 78, atk: 9, def: 7, spd: 8 }, moves: [{name: "Sputo", power: 1.1, description: "Uno sputo disprezzante ma efficace."}, {name: "Egoismo", power: 0, effect: 'atk_up', description: "Pensa solo a sé stesso e aumenta il suo attacco."}, {name: "Stagione delle Anatre!", power: 1.3, description: "Un attacco disperato e potente."}] },
            { id: 29, name: "Darwin Watterson", img: "https://i.pinimg.com/736x/44/ad/5f/44ad5f25f6dae6e19757b15346684583.jpg", stats: { hp: 80, atk: 7, def: 7, spd: 8 }, moves: [{name: "'Cattivo!'", power: 0, damage: [15, 15], uses: 2, description: "Da uno schiaffo all'avversario e toglie 15 hp."}, {name: "Amore Ovunque", power: 0, effect: 'infatuation', effectChance: 1.0, effectDuration: [3, 3], uses: 3, description: "Infatua l'avversario per 3 turni."}, {name: "Getto Potente", power: 0, damage: [10, 14], effect: 'burn', effectChance: 1.0, effectDuration: [3, 4], description: "Un getto d'acqua bollente che scotta il nemico."}] },
            { id: 77, name: "Detective Conan", img: "https://i.pinimg.com/736x/77/e4/e9/77e4e9ddb6f514b151c15d16b0cf207d.jpg", stats: { hp: 70, atk: 7, def: 6, spd: 9 }, moves: [{name: "Il Caso è Chiuso", power: 0, damage: [35, 35], uses: 1, description: "Infligge 35 danni al bersaglio."}, {name: "Orologio Spara-sedativi", power: 1.0, effect: 'sleep', effectChance: 0.9, effectDuration: [2,2], uses: 3, description: "Addormenta il nemico per due turni."}, {name: "Skateboard a Turbo", power: 0, damage: [8, 8], description: "Usa il suo skateboard per un attacco rapido."}] },
            { id: 95, name: "Dexter", img: "https://i.pinimg.com/736x/c8/68/e6/c868e63417b5653ac6f1bfb965cea28c.jpg", stats: { hp: 70, atk: 11, def: 5, spd: 9 }, moves: [{name: "Invenzione Geniale", power: 1.4, effect: 'random', description: "Usa un'invenzione casuale e potente."}, {name: "Raggio Laser", power: 1.3, description: "Un raggio laser preciso dal suo laboratorio."}, {name: "DEE DEE!", power: 1.0, effect: 'stun', effectChance: 0.3, effectDuration: [2,2], uses: 4, description: "La distrazione di sua sorella blocca il nemico."}] },
            { id: 58, name: "Doraemon", img: "https://i.pinimg.com/736x/b1/75/de/b175de80fb0f5ca9b5230f0b12f3c13c.jpg", stats: { hp: 85, atk: 7, def: 10, spd: 6 }, moves: [{name: "Chiusky a Sorpresa", power: 1.2, description: "Tira fuori un gadget a caso dalla tasca."}, {name: "Copri-pane mnemonico", power: 0, effect: 'stat_up', description: "Usa un gadget per potenziare le sue statistiche."}, {name: "Dokodemo Porta", power: 0, effect: 'invulnerability', effectDuration: [2, 2], uses: 3, description: "Diventa invulnerabile per 2 turni."}] },
            { id: 45, name: "Elsa", img: "https://i.pinimg.com/736x/fd/26/cd/fd26cd346c9e73430dc9ba28e318fb74.jpg", stats: { hp: 88, atk: 11, def: 7, spd: 8 }, moves: [{name: "Raggio Gelido", power: 1.3, effect: 'freeze', effectChance: 0.3, effectDuration: [2, 2], description: "Un raggio che ha una probabilità di congelare il nemico per 2 turni."}, {name: "Muro di Ghiaccio", power: 0, effect: 'invulnerability', effectDuration: [2, 2], uses: 3, description: "Diventa invulnerabile per 2 turni."}, {name: "Tormenta", power: 1.5, description: "Scatena una bufera di neve e ghiaccio."}] },
            { id: 44, name: "Empoleon", img: "https://i.pinimg.com/1200x/b2/52/ea/b252eac40b5327d0691ddf9e6c9ec7d3.jpg", stats: { hp: 95, atk: 10, def: 10, spd: 7 }, moves: [{name: "Bollaraggio", power: 1.3, description: "Un raggio di bolle ad alta pressione."}, {name: "Perforbecco", power: 1.2, description: "Un colpo preciso con il becco affilato."}, {name: "Alacciaio", power: 1.1, effect: 'def_up', description: "Colpisce con ali dure come l'acciaio."}] },
            { id: 93, name: "Eric Cartman", img: "https://i.pinimg.com/736x/31/3a/b7/313ab7f6d385f544ffc90681ae08c117.jpg", stats: { hp: 90, atk: 9, def: 10, spd: 4 }, moves: [{name: "Rispetta la mia autorità!", power: 0, damage: [8, 12], description: "Un colpo con un manganello che infligge 8-12 danni."}, {name: "Cheesy Poofs Curativi", power: 0, effect: 'heal', healAmount: [15, 20], uses: 4, description: "Mangia i suoi snack preferiti per curarsi."}, {name: "Lamenti Strazianti", power: 0, effect: 'stun', effectChance: 1.0, effectDuration: [2, 2], uses: 3, description: "Si lamenta così tanto da stordire il nemico per 2 turni."}] },
            { id: 75, name: "Ferb", img: "https://i.pinimg.com/736x/63/04/d3/6304d368076442119f65936ca107067c.jpg", stats: { hp: 80, atk: 8, def: 9, spd: 7 }, moves: [{name: "Costruzione Geniale", power: 0, damage: [6, 10], effect: 'random_status', effectChance: 0.5, description: "Infligge 6-10 danni e ha una probabilità di applicare uno status casuale."}, {name: "Raggio Laser", power: 0, damage: [14, 14], description: "Un potente raggio laser che infligge 14 danni."}, {name: "Dov'è Perry?", power: 0, effect: 'heal', healAmount: [30, 30], uses: 1, description: "Cura 30 HP (1 solo uso)."}] },
            { id: 5, name: "Finn", img: "https://i.pinimg.com/736x/29/83/75/298375aacfcc94f3310fad5578000f6d.jpg", stats: { hp: 80, atk: 9, def: 7, spd: 9 }, moves: [{name: "Colpo di Spada", power: 1.3, description: "Un fendente con la sua fidata spada."}, {name: "Urlo Eroico", power: 1.0, effect: 'atk_up', description: "Aumenta il proprio attacco."}, {name: "Avventura!", power: 1.4, description: "Un attacco imprevedibile e potente."}] },
            { id: 87, name: "Francine Smith", img: "https://i.pinimg.com/736x/18/c1/d2/18c1d2489a64b1b4f9cc78318e62da94.jpg", stats: { hp: 85, atk: 9, def: 7, spd: 8 }, moves: [{name: "Muffin Esplosivi", power: 1.4, description: "Lancia dei muffin... sospetti."}, {name: "Pettegolezzo Letale", power: 1.0, effect: 'def_down', description: "Un pettegolezzo che distrugge l'autostima e la difesa."}, {name: "Furia Repressa", power: 1.5, description: "Scatena anni di frustrazione repressa."}] },
            { id: 10, name: "Garnet", img: "https://i.pinimg.com/736x/65/9b/d2/659bd260c80c7ecb1e2c1d7c7c3e9508.jpg", stats: { hp: 95, atk: 11, def: 9, spd: 7 }, moves: [{name: "Guanti-Razzo", power: 1.4, description: "Scaglia i suoi guanti con forza esplosiva."}, {name: "Visione Futura", power: 0, effect: 'invulnerability', effectDuration: [2, 2], uses: 3, description: "Diventa invulnerabile per 2 turni."}, {name: "Elettrocinesi", power: 1.2, description: "Scatena una scarica elettrica."}] },
            { id: 80, name: "Giyu", img: "https://i.pinimg.com/736x/fa/78/dd/fa78ddb22728f7ae661b3c18615d1d68.jpg", stats: { hp: 92, atk: 11, def: 9, spd: 10 }, moves: [{name: "Respirazione Acqua", power: 1.4, description: "Usa una delle forme della Respirazione dell'Acqua."}, {name: "Calma Piatta", power: 0, effect: 'invulnerability', effectDuration: [2, 2], uses: 3, description: "Diventa invulnerabile per 2 turni."}, {name: "Fendente Impetuoso", power: 1.5, description: "Un fendente potente e deciso."}] },
            { id: 34, name: "Grizzly", img: "https://i.pinimg.com/1200x/ac/d7/36/acd736b2bc748e58f469c0911ad42567.jpg", stats: { hp: 92, atk: 9, def: 9, spd: 7 }, moves: [{name: "Carica Potente", power: 0, damage: [10, 12], description: "Carica il nemico infliggendo 10-12 danni."}, {name: "Motivazione alle Stelle", power: 0, effect: 'infatuation', effectChance: 1.0, effectDuration: [3, 3], uses: 3, description: "Infatua il bersaglio per 3 turni."}, {name: "Orso Super-Stanco", power: 0, effect: 'heal', healAmount: [40, 40], uses: 2, description: "Cura un bersaglio di 40 HP."}] },
            { id: 27, name: "Gumball", img: "https://i.pinimg.com/736x/af/61/0f/af610f55e819f4bd3f37e5001a2b19ee.jpg", stats: { hp: 78, atk: 8, def: 6, spd: 9 }, moves: [{name: "Potere dell'Amicizia", power: 0, damage: [25, 25], uses: 3, description: "Fa 25 di danno."}, {name: "Idea Geniale, Forse (?)", power: 0, effect: 'special_random', description: "Si cura di 18 hp, oppure, fa 12 di danno."}, {name: "Vendetta di Rob", power: 0, damage: [10, 10], description: "Fa 10 di danno."}] },
            { id: 90, name: "Homer Simpson", img: "https://i.pinimg.com/1200x/1d/b9/18/1db918fe2b5dff69f35186ad20cc1752.jpg", stats: { hp: 120, atk: 8, def: 8, spd: 3 }, moves: [{name: "D'oh!", power: 0, damage: [9, 10], description: "Si colpisce da solo, ma danneggia anche il nemico."}, {name: "Lancio di Ciambella", power: 1.0, description: "Lancia una ciambella con precisione sorprendente."}, {name: "Sonnellino Rigenerante", power: 0, effect: 'heal', healAmount: [25, 30], uses: 4, description: "Si addormenta per recuperare molti HP."}] },
            { id: 6, name: "Jake", img: "https://i.pinimg.com/736x/cb/96/5a/cb965ab6c13eaf52f182474b6fc9a7d1.jpg", stats: { hp: 95, atk: 7, def: 10, spd: 5 }, moves: [{name: "Pugno Gigante", power: 1.5, description: "Trasforma il pugno per un colpo devastante."}, {name: "Mutaforma", power: 0, effect: 'invulnerability', effectDuration: [2, 2], uses: 3, description: "Diventa invulnerabile per 2 turni."}, {name: "Scudo Corporeo", power: 0, effect: 'invulnerability', effectDuration: [2, 2], uses: 3, description: "Diventa invulnerabile per 2 turni."}] },
            { id: 82, name: "Jerry", img: "https://i.pinimg.com/736x/be/2f/e1/be2fe1bde39e5005bdc4cea479dcf6f7.jpg", stats: { hp: 65, atk: 7, def: 5, spd: 13 }, moves: [{name: "Fuga Astuta", power: 0, effect: 'invulnerability', effectDuration: [2, 2], uses: 3, description: "Diventa invulnerabile per 2 turni."}, {name: "Colpo di Formaggio", power: 0, damage: [5,5], effect: 'lifesteal', healAmount: 10, description: "Infligge 5 danni e si cura di 10 HP."}, {name: "Martello Gigante", power: 0, damage: [10,10], effect: 'stun', effectChance: 0.5, effectDuration: [1,1], description: "Infligge 10 danni e può stordire per 1 turno."}] },
            { id: 26, name: "Johnny Bravo", img: "https://i.pinimg.com/736x/b4/cd/95/b4cd959a9bb7efaf289ba3e4ae85d4b8.jpg", stats: { hp: 90, atk: 12, def: 8, spd: 5 }, moves: [{name: "Posa Plastica", power: 0, effect: 'atk_up', description: "Fa una posa che aumenta il suo attacco."}, {name: "Hey, Pupa!", power: 1.3, effect: 'infatuation', effectChance: 0.5, effectDuration: [3, 3], description: "Un approccio che può infatuare il nemico."}, {name: "Karate Chop!", power: 1.4, description: "Un colpo di karate veloce e potente."}] },
            { id: 73, name: "Katara", img: "https://i.pinimg.com/736x/00/14/5e/00145ebb0ae3ae4b2af824d831faf313.jpg", stats: { hp: 88, atk: 10, def: 8, spd: 9 }, moves: [{name: "Frusta d'Acqua", power: 1.3, description: "Colpisce il nemico con una frusta d'acqua."}, {name: "Dominio del Sangue", power: 1.0, effect: 'stun', effectChance: 0.8, effectDuration: [2,2], uses: 3, description: "Controlla il nemico per due turni."}, {name: "Guarigione Acquatica", power: 0, effect: 'heal', healAmount: [15, 20], uses: 4, description: "Usa l'acqua per curare le sue ferite."}] },
            { id: 64, name: "Kirby", img: "https://i.pinimg.com/736x/ba/e6/63/bae6637b3efecfd002f0c1f9605e53be.jpg", stats: { hp: 95, atk: 9, def: 10, spd: 7 }, moves: [{name: "Aspirazione", power: 1.2, effect: 'lifesteal', healAmount: 5, description: "Aspira il nemico per copiarne le abilità e curarsi."}, {name: "Trasformazione Copia", power: 1.4, description: "Usa il potere che ha copiato."}, {name: "Stella Warp", power: 1.4, description: "Evoca la sua stella per un attacco in picchiata."}] },
            { id: 54, name: "Ladybug", img: "https://i.pinimg.com/736x/72/32/f1/7232f16bdab9dd11a2fa77403a1fe9f1.jpg", stats: { hp: 85, atk: 9, def: 9, spd: 10 }, moves: [{name: "Yo-Yo Veloce", power: 0, damage: [8, 10], description: "Usa il suo yo-yo come arma, infliggendo 8-10 danni."}, {name: "Lucky Charm", power: 0, effect: 'random_status', effectChance: 1.0, effectDuration: [2, 2], uses: 4, description: "Evoca un oggetto che applica uno status casuale al nemico per 2 turni."}, {name: "Miraculous Ladybug", power: 0, effect: 'heal_percent', healPercent: 1.0, uses: 2, description: "Ripara i danni e cura il 100% degli HP massimi."}] },
            { id: 96, name: "Lara Croft", img: "https://i.pinimg.com/736x/44/b5/78/44b5784b5428b7ec98410ae142330966.jpg", stats: { hp: 85, atk: 11, def: 7, spd: 10 }, moves: [{name: "Doppia Pistola", power: 1.4, description: "Una raffica di colpi da entrambe le pistole."}, {name: "Salto Acrobatico", power: 0, effect: 'invulnerability', effectDuration: [2, 2], uses: 3, description: "Diventa invulnerabile per 2 turni."}, {name: "Piccozza da Scalata", power: 1.2, description: "Un attacco corpo a corpo con la sua piccozza."}] },
            { id: 9, name: "Lapis", img: "https://i.pinimg.com/1200x/09/fb/12/09fb12467957da96913fc8f75e6f6356.jpg", stats: { hp: 88, atk: 11, def: 6, spd: 9 }, moves: [{name: "Idrocinesi", power: 1.4, description: "Manipola l'acqua per un attacco potente."}, {name: "Ali d'Acqua", power: 1.1, description: "Un attacco rapido usando ali d'acqua."}, {name: "Prigione Acquatica", power: 1.0, effect: 'stun', effectChance: 0.6, effectDuration: [2,2], uses: 3, description: "Intrappola il nemico per due turni."}, {name: "Vortice d'Acqua", power: 0, damage: [8, 8], effect: 'vortex', effectChance: 1.0, effectDuration: [5, 5], effectDamage: [5, 5], description: "Infligge 8 danni e intrappola il nemico per 5 turni, infliggendo 5 danni extra a turno."}] },
            { id: 46, name: "Leavanny", img: "https://i.pinimg.com/736x/72/b6/ff/72b6ffcd1396128f0f2235281171bc92.jpg", stats: { hp: 88, atk: 10, def: 8, spd: 9 }, moves: [{name: "Fendifoglia", power: 1.3, description: "Colpisce con lame di foglie affilate."}, {name: "Forbice X", power: 1.4, description: "Un potente doppio fendente."}, {name: "Rete Vischiosa", power: 0, effect: 'spd_down', description: "Lancia una rete che rallenta il nemico."}] },
            { id: 85, name: "Leela", img: "https://i.pinimg.com/1200x/6e/c8/b6/6ec8b67dc6bb062afc2007495b041e84.jpg", stats: { hp: 90, atk: 10, def: 8, spd: 9 }, moves: [{name: "Calcio Ciclope", power: 1.3, description: "Un calcio potente e preciso."}, {name: "Pistola Laser", power: 1.2, effect: 'burn', effectChance: 0.4, effectDuration: [3, 4], description: "Spara un colpo dalla sua pistola standard con il 40% di chance di bruciare."}, {name: "Furia da Mutante", power: 1.5, description: "Scatena la sua rabbia per un attacco devastante."}] },
            { id: 4, name: "Leon Kennedy", img: "https://i.pinimg.com/736x/0a/27/cd/0a27cd44aae181df0884d85bf18d0574.jpg", stats: { hp: 90, atk: 9, def: 8, spd: 8 }, moves: [{name: "Colpo di Pistola", power: 1.1, description: "Un colpo mirato e veloce."}, {name: "Calcio Rotante", power: 1.4, description: "Un attacco fisico che può sbilanciare."}, {name: "Schivata Esperta", power: 0, effect: 'invulnerability', effectDuration: [2, 2], uses: 3, description: "Diventa invulnerabile per 2 turni."}] },
            { id: 100, name: "Link", img: "https://i.pinimg.com/736x/be/29/0a/be290ac4f5b6f1de6f88ee2099e04da1.jpg", stats: { hp: 95, atk: 11, def: 9, spd: 8 }, moves: [{name: "Fendente Circolare", power: 1.3, description: "Un attacco ad area con la Spada Maestra."}, {name: "Lancio di Bomba", power: 1.4, description: "Lancia una bomba che esplode."}, {name: "Freccia di Luce", power: 1.7, description: "Un colpo sacro e potentissimo."}] },
            { id: 91, name: "Lisa Simpson", img: "https://i.pinimg.com/736x/bf/df/10/bfdf10aa4399efd5fc1430601b589613.jpg", stats: { hp: 75, atk: 7, def: 7, spd: 8 }, moves: [{name: "Ipnosi", power: 0, effect: 'sleep', effectChance: 1.0, effectDuration: [4, 4], uses: 2, description: "Addormenta il nemico per 4 turni."}, {name: "Colpo Geniale", power: 0, damage: [6, 12], description: "Infligge da 6 a 12 danni."}, {name: "Riposa la Mente", power: 0, effect: 'heal', healAmount: [10, 15], uses: 10, description: "Cura dai 10 ai 15 HP."}] },
            { id: 59, name: "Lola Bunny", img: "https://i.pinimg.com/1200x/ee/12/ad/ee12ad4d87c9f5e3bafb2e1bc9676439.jpg", stats: { hp: 80, atk: 8, def: 7, spd: 10 }, moves: [{name: "Tiro da Tre Punti", power: 0, damage: [8, 12], description: "Lancia la palla con una precisione mortale."}, {name: "Nascondino", power: 0, effect: 'invulnerability', effectDuration: [1, 1], description: "Diventa invulnerabile per 1 turno."}, {name: "Sguardo Ammaliante", power: 0, effect: 'infatuation', effectChance: 1.0, effectDuration: [3, 3], description: "Distrae il nemico con il suo fascino, infatuandolo."}, {name: "Ruba Vita", power: 0, damage: [7, 9], effect: 'lifesteal', uses: 4, description: "Toglie 7-9 HP e si cura della stessa somma."}] },
            { id: 42, name: "Lucario", img: "https://i.pinimg.com/1200x/6f/bf/ab/6fbfab2a5aceb54d48323128e7a10ae4.jpg", stats: { hp: 90, atk: 11, def: 8, spd: 10 }, moves: [{name: "Forzasfera", power: 1.4, description: "Una sfera di aura che non può essere schivata."}, {name: "Palmoforza", power: 1.2, description: "Un colpo di palmo carico di energia."}, {name: "Ossoraffica", power: 1.3, description: "Crea un osso di energia e colpisce ripetutamente."}] },
            { id: 16, name: "Luigi", img: "https://i.pinimg.com/1200x/0b/49/30/0b49308522463829166e76b0d914c8b8.jpg", stats: { hp: 82, atk: 8, def: 7, spd: 9 }, moves: [{name: "Pugno Verde", power: 1.2, description: "Un pugno caricato di energia verde."}, {name: "Salto Svitato", power: 1.1, description: "Un salto goffo ma efficace."}, {name: "Poltergust", power: 1.0, effect: 'def_down', description: "Aspira le difese del nemico."}] },
            { id: 7, name: "Marceline", img: "https://i.pinimg.com/736x/bb/93/5e/bb935e39f2d66248b6e4178227bdb233.jpg", stats: { hp: 85, atk: 10, def: 7, spd: 10 }, moves: [{name: "Assolo di Basso", power: 1.3, effect: 'stun', effectChance: 0.7, effectDuration: [2, 2], uses: 5, description: "Un'onda sonica che danneggia e può stordire."}, {name: "Morso Vampirico", power: 0, damage: [9, 12], effect: 'lifesteal_percent', healPercent: 0.5, description: "Infligge 9-12 danni e cura del 50% del danno inflitto."}, {name: "Forma d'Ombra", power: 0, effect: 'invulnerability', effectDuration: [2, 2], uses: 3, description: "Diventa invulnerabile per 2 turni."}] },
            { id: 15, name: "Mario", img: "https://i.pinimg.com/736x/61/62/b5/6162b56bc61a4050bb34d7203e03642d.jpg", stats: { hp: 85, atk: 9, def: 8, spd: 8 }, moves: [{name: "Salto a Terra", power: 1.2, description: "Il suo classico e potente pestone."}, {name: "Palla di Fuoco", power: 1.3, description: "Lancia una palla di fuoco che rimbalza."}, {name: "Super Fungo", power: 0, effect: 'heal', healAmount: [20, 20], uses: 4, description: "Mangia un fungo per recuperare salute."}] },
            { id: 52, name: "Master Shifu", img: "https://i.pinimg.com/1200x/f2/e6/8c/f2e68c6b0502f1dada1982254876933a.jpg", stats: { hp: 85, atk: 10, def: 7, spd: 11 }, moves: [{name: "Presa del Dito Wuxi", power: 1.5, description: "Una tecnica letale e precisa."}, {name: "Calcio Veloce", power: 1.2, description: "Una raffica di calci rapidissimi."}, {name: "Pace Interiore", power: 0, effect: 'stat_up', description: "Si concentra per aumentare attacco e difesa."}] },
            { id: 92, name: "Ned Flanders", img: "https://pbs.twimg.com/media/Fenv8bnWIAIdub7.jpg:large", stats: { hp: 90, atk: 8, def: 10, spd: 6 }, moves: [{name: "Salve Salvinello!", power: 0.9, description: "Un saluto così amichevole da essere sospetto."}, {name: "Preghiera Protettiva", power: 0, effect: 'invulnerability', effectDuration: [2, 2], uses: 3, description: "Diventa invulnerabile per 2 turni."}, {name: "Furia Repressa", power: 1.9, description: "Scatena una rabbia inaspettata e devastante."}] },
            { id: 28, name: "Nicole Watterson", img: "https://i.pinimg.com/736x/81/24/e4/8124e43da43e1d06dcdbca15f22a0cd9.jpg", stats: { hp: 90, atk: 12, def: 8, spd: 11 }, moves: [{name: "Furia Cieca", power: 1.6, description: "Scatena una rabbia incontenibile."}, {name: "Sguardo Assassino", power: 0, effect: 'stun', effectChance: 1.0, effectDuration: [2, 2], uses: 3, description: "Stordisce il bersaglio per 2 turni."}, {name: "Super Velocità", power: 1.3, description: "Si muove così velocemente da essere quasi invisibile."}, {name: "Sguardo Letale", power: 0, effect: 'halve_hp', uses: 3, description: "Divide gli HP massimi dell'avversario del 50%."}] },
            { id: 40, name: "Oggy", img: "https://i.pinimg.com/736x/ca/8a/de/ca8ade9acdf1115e9364fd30abd41754.jpg", stats: { hp: 75, atk: 7, def: 7, spd: 8 }, moves: [{name: "Acchiappamosche", power: 1.1, description: "Colpisce con un acchiappamosche."}, {name: "Fuga Disperata", power: 0, effect: 'invulnerability', effectDuration: [2, 2], uses: 3, description: "Diventa invulnerabile per 2 turni."}, {name: "Urlo di Panico", power: 0.8, effect: 'def_down', description: "Un urlo che spaventa e indebolisce."}] },
            { id: 94, name: "Olaf", img: "https://i.pinimg.com/736x/a5/d4/2f/a5d42f86e89066cb61ebafe1f8a47fa7.jpg", stats: { hp: 85, atk: 6, def: 7, spd: 7 }, moves: [{name: "Abbracci Calorosi", power: 0, effect: 'heal', healAmount: [15, 20], uses: 4, description: "Un abbraccio che cura un po'."}, {name: "Turbine di Neve", power: 1.2, description: "Crea un piccolo turbine di neve."}, {name: "Racconto Inappropriato", power: 0, effect: 'stun', effectChance: 0.2, effectDuration: [2,2], uses: 4, description: "Racconta una storia che confonde il nemico."}, {name: "Bufera di Neve", power: 0, effect: 'freeze', effectChance: 1.0, effectDuration: [3, 4], uses: 3, description: "Congela il nemico per 3-4 turni."}] },
            { id: 32, name: "Orso Bianco", img: "https://i.pinimg.com/736x/9c/36/59/9c3659e69419f16abe572e4241667bcd.jpg", stats: { hp: 90, atk: 10, def: 9, spd: 7 }, moves: [{name: "Colpo Silenzioso", power: 0, damage: [30, 30], uses: 1, description: "Un colpo letale che infligge 30 danni."}, {name: "Colpo da Maestro", power: 0, damage: [8, 13], description: "Una serie di colpi precisi che infliggono 8-13 danni."}, {name: "Scivolata Gelida", power: 0, damage: [4, 4], effect: 'freeze', effectChance: 1.0, effectDuration: [2, 3], uses: 2, description: "Scivola e congela il nemico per 2-3 turni."}] },
            { id: 33, name: "Panda", img: "https://i.pinimg.com/1200x/cf/d2/85/cfd285a97021713f6f5cada516043233.jpg", stats: { hp: 80, atk: 7, def: 8, spd: 6 }, moves: [{name: "Filtro Kawaii", power: 0, damage: [7, 12], description: "Un attacco carino ma efficace che infligge 7-12 danni."}, {name: "Cuoricini Curativi", power: 0, effect: 'heal', healAmount: [14, 19], uses: 4, description: "Cura un alleato di 14-19 HP."}, {name: "Abbraccio Coccoloso", power: 0, damage: [10, 10], effect: 'stun', effectChance: 0.5, effectDuration: [2, 2], uses: 5, description: "Stritola il nemico, infliggendo 10 danni e con il 50% di stordirlo."}] },
            { id: 13, name: "Patrick Stella", img: "https://i.pinimg.com/1200x/27/e0/2e/27e02eadbe6a321a7d0a9641a394c811.jpg", stats: { hp: 90, atk: 9, def: 8, spd: 3 }, moves: [{name: "Testata", power: 1.4, description: "Una potente testata."}, {name: "Lancio della Roccia", power: 1.6, description: "Solleva e lancia la sua casa-roccia."}, {name: "Dormita Rigenerante", power: 0, effect: 'heal', healAmount: [20, 25], uses: 4, description: "Si addormenta per recuperare HP."}] },
            { id: 11, name: "Perla", img: "https://i.pinimg.com/736x/7b/2e/b7/7b2eb73a3f511efa5bc182d1db60191b.jpg", stats: { hp: 80, atk: 9, def: 7, spd: 11 }, moves: [{name: "Colpo di Lancia", power: 1.5, description: "Un affondo preciso e veloce potenziato."}, {name: "Ologramma", power: 0.8, effect: 'stun', effectChance: 1.0, effectDuration: [2, 2], uses: 4, description: "Crea un ologramma per confondere e stordire per 2 turni."}, {name: "Parata Perfetta", power: 0, effect: 'invulnerability', effectDuration: [2, 2], uses: 3, description: "Diventa invulnerabile per 2 turni."}] },
            { id: 76, name: "Perry l'Ornitorinco", img: "https://i.pinimg.com/736x/59/f2/98/59f29865a1e5fd69d69984b4a8d91729.jpg", stats: { hp: 85, atk: 10, def: 9, spd: 10 }, moves: [{name: "Colpo di Coda", power: 1.3, description: "Un potente colpo con la coda."}, {name: "Cappello-Boomerang", power: 1.2, description: "Lancia il suo cappello come un boomerang."}, {name: "Sguardo Intenso", power: 1.0, effect: 'def_down', description: "Uno sguardo che intimidisce il nemico."}] },
            { id: 83, name: "Peter Griffin", img: "https://i.pinimg.com/736x/9e/40/74/9e4074bbe7890cd245b51b9ff5c0e33c.jpg", stats: { hp: 110, atk: 9, def: 7, spd: 4 }, moves: [{name: "Rissa da Bar", power: 1.3, description: "Inizia una rissa senza motivo."}, {name: "Uccello Uccello Uccello", power: 1.2, effect: 'stun', effectChance: 0.3, effectDuration: [2,2], uses: 4, description: "Balla in modo così fastidioso da bloccare il nemico."}, {name: "Risata fastidiosa", power: 1.0, effect: 'def_down', description: "Una risata che deconcentra e indebolisce."}] },
            { id: 74, name: "Phineas", img: "https://i.pinimg.com/736x/cf/84/b5/cf84b5f2d0db3addab2509f12dbcfe82.jpg", stats: { hp: 75, atk: 7, def: 7, spd: 9 }, moves: [{name: "Costruzione Geniale", power: 0, damage: [6, 10], effect: 'random_status', effectChance: 0.5, description: "Infligge 6-10 danni e ha una probabilità di applicare uno status casuale."}, {name: "Raggio Laser", power: 0, damage: [14, 14], description: "Un potente raggio laser che infligge 14 danni."}, {name: "Dov'è Perry?", power: 0, effect: 'heal', healAmount: [30, 30], uses: 1, description: "Cura 30 HP (1 solo uso)."}] },
            { id: 57, name: "Picchio Picchiarello", img: "https://i.pinimg.com/736x/55/7a/63/557a63502c086c8e74cd2f5868b38f23.jpg", stats: { hp: 75, atk: 8, def: 6, spd: 11 }, moves: [{name: "Beccata Rapida", power: 1.2, description: "Una serie di beccate velocissime."}, {name: "Risata Folle", power: 0.8, effect: 'def_down', description: "Una risata che deconcentra e indebolisce."}, {name: "Volo Imprevedibile", power: 0, effect: 'invulnerability', effectDuration: [2, 2], uses: 3, description: "Diventa invulnerabile per 2 turni."}] },
            { id: 41, name: "Pikachu", img: "https://i.pinimg.com/736x/ad/65/b6/ad65b669746561313925ffff392518bc.jpg", stats: { hp: 80, atk: 9, def: 6, spd: 11 }, moves: [{name: "Fulmine", power: 1.3, description: "Una potente scarica elettrica."}, {name: "Attacco Rapido", power: 1.1, description: "Un attacco che colpisce per primo."}, {name: "Locomovolt", power: 1.5, description: "Si carica di elettricità e placca il nemico."}] },
            { id: 51, name: "Po", img: "https://i.pinimg.com/1200x/fb/99/a5/fb99a5c7ce5b313ed1c4e71ee0260a9b.jpg", stats: { hp: 105, atk: 10, def: 10, spd: 5 }, moves: [{name: "Pancia Rimbalzante", power: 1.2, description: "Usa la sua pancia per respingere e danneggiare."}, {name: "Mossa Wuxi", power: 1.8, description: "La leggendaria presa del dito Wuxi."}, {name: "Divora Ravioli", power: 0, effect: 'heal', healAmount: [25, 30], uses: 4, description: "Una pausa per uno spuntino rigenerante."}] },
            { id: 36, name: "Ponygon", img: "https://i.pinimg.com/1200x/4a/ee/29/4aee29b5bc03c3f3dfbec858428e86a9.jpg", stats: { hp: 100, atk: 11, def: 12, spd: 10 }, moves: [{name: "Shudoruk", power: 1.4, effect: 'def_up', description: "Carica il nemico con un'armatura che aumenta la Difesa."}, {name: "Go Shudoruk", power: 1.8, description: "Una carica inarrestabile alla massima velocità."}, {name: "Armatura Suprema", power: 0, effect: 'heal', healAmount: [10, 15], uses: 4, description: "Indurisce l'armatura al massimo e recupera HP."}] },
            { id: 98, name: "Princess Peach", img: "https://i.pinimg.com/1200x/d5/dc/9d/d5dc9dbe1fd202663b5338fc582cdc24.jpg", stats: { hp: 82, atk: 8, def: 8, spd: 9 }, moves: [{name: "Attacco Ombrello", power: 1.2, description: "Colpisce con il suo elegante ombrello."}, {name: "Cuore Curativo", power: 0, effect: 'heal', healAmount: [15, 20], uses: 4, description: "Un'aura a forma di cuore che cura."}, {name: "Lancio di Rapa", power: 1.1, description: "Estrae una rapa da terra e la lancia."}] },
            { id: 66, name: "Raffaello", img: "https://i.pinimg.com/1200x/46/36/73/463673bdc942b4d0d948fa9190a0d672.jpg", stats: { hp: 90, atk: 11, def: 9, spd: 8 }, moves: [{name: "Colpo di Sai", power: 1.3, description: "Un attacco rapido e preciso con i suoi sai."}, {name: "Attacco Furioso", power: 1.5, description: "Una raffica di colpi carichi di rabbia."}, {name: "Battuta Sarcastica", power: 1.0, description: "Una battuta che fa male... in qualche modo."}] },
            { id: 38, name: "Rekkit", img: "https://i.pinimg.com/736x/d5/98/19/d598195faf8ad3a4881c49f7a356bd6d.jpg", stats: { hp: 85, atk: 8, def: 8, spd: 7 }, moves: [{name: "Magia Casuale", power: 1.3, description: "Lancia un incantesimo dall'effetto imprevedibile."}, {name: "Abbraccio Gigante", power: 1.1, description: "Un abbraccio affettuoso ma stritolante."}, {name: "Porta Dimensionale", power: 0, effect: 'invulnerability', effectDuration: [2, 2], uses: 3, description: "Diventa invulnerabile per 2 turni."}] },
            { id: 56, name: "Rena Rouge", img: "https://i.pinimg.com/736x/de/9d/47/de9d4781d1e2a1956088db188b16dbfc.jpg", stats: { hp: 82, atk: 8, def: 8, spd: 10 }, moves: [{name: "Flauto Traverso", power: 1.2, description: "Usa il suo flauto come arma contundente."}, {name: "Miraggio", power: 0, effect: 'heal', healAmount: [6, 10], uses: 4, description: "Crea un'illusione che confonde il nemico e recupera da 6 a 10 HP."}, {name: "Agilità Volpina", power: 0.8, effect: 'spd_up', description: "Aumenta la sua velocità e sferra un piccolo attacco."}] },
            { id: 22, name: "Robin", img: "https://i.pinimg.com/736x/e7/3e/e2/e73ee222f16116892d37961f6ccf511a.jpg", stats: { hp: 85, atk: 9, def: 8, spd: 10 }, moves: [{name: "Lancio Batarang", power: 1.2, description: "Lancia uno dei suoi gadget iconici."}, {name: "Bastone da Combattimento", power: 1.3, description: "Una serie di colpi rapidi col bastone."}, {name: "Strategia Tattica", power: 0, effect: 'atk_up', description: "Analizza il nemico e aumenta il proprio attacco."}] },
            { id: 30, name: "Robot Boy", img: "https://i.pinimg.com/736x/4d/15/56/4d1556d8ad55d90c868d0c6ba5642ffe.jpg", stats: { hp: 95, atk: 11, def: 10, spd: 9 }, moves: [{name: "Super Attivazione", power: 1.5, description: "Si trasforma per un attacco devastante."}, {name: "Raggio Laser", power: 1.3, description: "Spara un laser dai suoi occhi."}, {name: "Scudo Energetico", power: 0, effect: 'invulnerability', effectDuration: [2, 2], uses: 3, description: "Diventa invulnerabile per 2 turni."}] },
            { id: 89, name: "Roger", img: "https://i.pinimg.com/736x/f7/7a/f5/f77af51ffcf31ec171aedd80322811bc.jpg", stats: { hp: 80, atk: 9, def: 7, spd: 9 }, moves: [{name: "Travestimento", power: 1.2, effect: 'random', description: "Si traveste e sferra un attacco imprevedibile."}, {name: "Attacco a Sorpresa", power: 1.4, description: "Appare dal nulla per colpire."}, {name: "Vino e Lamentele", power: 0, effect: 'heal', healAmount: [10, 15], uses: 4, description: "Si lamenta bevendo vino e recupera HP."}] },
            { id: 17, name: "Rosalinda", img: "https://i.pinimg.com/736x/09/14/f0/0914f029e712e92de9d4f0081a5da032.jpg", stats: { hp: 88, atk: 10, def: 8, spd: 8 }, moves: [{name: "Lancio Sfavillotto", power: 1.3, description: "Lancia uno dei suoi Sfavillotti."}, {name: "Scudo Cosmico", power: 0, effect: 'invulnerability', effectDuration: [2, 2], uses: 3, description: "Diventa invulnerabile per 2 turni."}, {name: "Onda Gravitazionale", power: 1.2, description: "Altera la gravità per danneggiare."}] },
            { id: 43, name: "Roserade", img: "https://i.pinimg.com/1200x/67/88/49/678849c01d18a4e0b90038bc069642ce.jpg", stats: { hp: 85, atk: 10, def: 7, spd: 9 }, moves: [{name: "Velenospina", power: 1.2, effect: 'poison', effectChance: 0.5, effectDuration: [3, 4], effectDamage: [5, 7], description: "Lancia spine che possono avvelenare il nemico."}, {name: "Gigassorbimento", power: 1.1, effect: 'lifesteal', healAmount: 3, description: "Assorbe l'energia vitale del nemico, recuperando 3 HP."}, {name: "Aromaterapia", power: 0, effect: 'heal', healAmount: [10, 15], uses: 4, description: "Rilascia un profumo che cura."}, {name: "Petalodanza", power: 0, damage: [6, 10], effect: 'lifesteal_percent', healPercent: 0.5, description: "Infligge 6-10 danni e cura del 50% del danno inflitto."}] },
            { id: 14, name: "Sandy", img: "https://i.pinimg.com/736x/0a/aa/e9/0aaae99134d01ff0a173ef47eb6b08bf.jpg", stats: { hp: 82, atk: 10, def: 7, spd: 9 }, moves: [{name: "Karate Chop", power: 1.3, description: "Un colpo di karate fulmineo."}, {name: "Lazo Texano", power: 1.1, description: "Cattura e sbatte il nemico."}, {name: "Invenzione Geniale", power: 0, effect: 'atk_up', description: "Usa una delle sue invenzioni per potenziarsi."}] },
            { id: 79, name: "Shinobu", img: "https://i.pinimg.com/736x/e4/61/5c/e4615cec0e441309da374106183f0b23.jpg", stats: { hp: 80, atk: 8, def: 7, spd: 12 }, moves: [{name: "Danza delle Farfalle", power: 1.2, effect: 'poison', effectChance: 0.7, effectDuration: [3, 4], effectDamage: [4, 6], description: "Una serie di colpi rapidi e velenosi."}, {name: "Puntura Velenosa", power: 1.3, effect: 'poison', effectChance: 1.0, effectDuration: [3, 4], effectDamage: [6, 9], description: "Inietta un veleno potente nel nemico."}, {name: "Velocità Sovrumana", power: 0, effect: 'spd_up', description: "Si muove a velocità accecante."}, {name: "Farfalla Curatrice", power: 0, effect: 'heal', healAmount: [15, 30], uses: 4, description: "Cura se stessa di 15-30 HP."}] },
            { id: 50, name: "Sdentato", img: "https://i.pinimg.com/736x/ff/55/0d/ff550dddd5b612d28fcc3524937826cb.jpg", stats: { hp: 95, atk: 11, def: 8, spd: 12 }, moves: [{name: "Colpo al Plasma", power: 1.6, description: "Un colpo di plasma esplosivo."}, {name: "Volo Acrobatico", power: 1.1, description: "Un attacco aereo rapido e agile."}, {name: "Invisibilità Notturna", power: 0, effect: 'invulnerability', effectDuration: [2, 2], uses: 3, description: "Diventa invulnerabile per 2 turni."}] },
            { id: 1, name: "Son Goku", img: "https://i.pinimg.com/1200x/37/5c/2f/375c2fd286cdc41c06764f91f708a687.jpg", stats: { hp: 100, atk: 12, def: 8, spd: 10 }, moves: [{name: "Kamehameha", power: 1.2, description: "Un potente raggio di energia."}, {name: "Kaioken", power: 1.5, description: "Aumenta la potenza, ma è rischioso."}, {name: "Sfera Genkidama", power: 2.0, uses: 2, description: "Un attacco devastante che richiede tempo."}] },
            { id: 31, name: "Sonic", img: "https://i.pinimg.com/736x/b2/e8/3a/b2e83aa2b39347d771851f394b53737f.jpg", stats: { hp: 85, atk: 9, def: 7, spd: 13 }, moves: [{name: "Spin Dash", power: 1.2, description: "Si appallottola e carica a grande velocità."}, {name: "Homing Attack", power: 1.3, description: "Un attacco a ricerca che non manca mai il bersaglio."}, {name: "Boost Sonico", power: 1.1, effect: 'spd_up', description: "Supera la barriera del suono per attaccare."}] },
            { id: 67, name: "Spinel", img: "https://i.pinimg.com/736x/d2/78/b0/d278b0606af1be5a2fb8ebf69dfca045.jpg", stats: { hp: 85, atk: 10, def: 6, spd: 12 }, moves: [{name: "Pugno Allungabile", power: 1.3, description: "Colpisce da lontano con un pugno elastico."}, {name: "Girotondo Veloce", power: 1.2, description: "Gira su se stessa colpendo ripetutamente."}, {name: "Iniettore di Veleno", power: 1.5, effect: 'poison', effectChance: 1.0, effectDuration: [3, 4], effectDamage: [7, 10], description: "Usa la sua falce per un attacco velenoso."}] },
            { id: 12, name: "Spongebob", img: "https://i.pinimg.com/736x/08/9d/56/089d562f45d59b2f7e37e643a5ebf927.jpg", stats: { hp: 75, atk: 8, def: 6, spd: 8 }, moves: [{name: "Soffio di Bolle", power: 1.0, description: "Soffia bolle che infastidiscono e danneggiano."}, {name: "Colpo di Spatola", power: 1.2, description: "Un colpo deciso con la sua fida spatola."}, {name: "Risata Irritante", power: 0.5, effect: 'def_down', description: "Infastidisce il nemico riducendone la difesa."}] },
            { id: 88, name: "Stan Smith", img: "https://i.pinimg.com/736x/45/30/5d/45305de4611f5b7da0ae72ad43123391.jpg", stats: { hp: 90, atk: 11, def: 9, spd: 7 }, moves: [{name: "Patriota Americano", power: 1.4, description: "Un attacco pieno di orgoglio nazionale."}, {name: "Colpo di Pistola CIA", power: 1.2, description: "Un colpo preciso e professionale."}, {name: "Tostapane d'Oro", power: 1.3, description: "Usa il suo tostapane per un attacco a sorpresa."}] },
            { id: 24, name: "Stellarubia", img: "https://i.pinimg.com/1200x/53/12/37/53123757cb3c81231a2b4fe641a2fac3.jpg", stats: { hp: 92, atk: 11, def: 8, spd: 9 }, moves: [{name: "Starbolt", power: 1.5, description: "Lancia potenti proiettili di energia."}, {name: "Volo Super Sonico", power: 1.2, description: "Carica il nemico a velocità supersonica."}, {name: "Forza Tamaraneana", power: 1.3, description: "Un colpo che sfrutta la sua forza aliena."}] },
            { id: 8, name: "Steven", img: "https://i.pinimg.com/736x/1c/3c/83/1c3c83c96596d34adda0c0d9f23d34e8.jpg", stats: { hp: 90, atk: 7, def: 11, spd: 6 }, moves: [{name: "Scudo Rosa", power: 0, effect: 'invulnerability', effectDuration: [2, 2], uses: 2, description: "Diventa invulnerabile per 2 turni."}, {name: "Guarigione Empatica", power: 0, effect: 'heal_percent', healPercent: 0.4, uses: 2, description: "Si cura del 40% degli HP massimi."}, {name: "Canzone del Cuore", power: 0, effect: 'sleep', effectChance: 1.0, effectDuration: [2, 2], uses: 3, description: "Addormenta il nemico per 2 turni."}, {name: "Scudo Boomerang", power: 0, damage: [9, 13], description: "Lancia il suo scudo, infliggendo 9-13 danni."}] },
            { id: 84, name: "Stewie Griffin", img: "https://i.pinimg.com/1200x/ff/37/ea/ff37ea1eb4a933d3ce1613a255e1fa6b.jpg", stats: { hp: 75, atk: 12, def: 6, spd: 7 }, moves: [{name: "Raggio Laser", power: 1.5, description: "Spara un raggio dalla sua pistola laser."}, {name: "Controllo Mentale", power: 0, effect: 'stun', effectChance: 0.5, effectDuration: [2,2], uses: 3, description: "Controlla la mente del nemico per due turni."}, {name: "Dominazione del Mondo!", power: 1.8, description: "Un piano diabolico che infligge danni enormi."}] },
            { id: 70, name: "Superboy", img: "https://i.pinimg.com/736x/80/5f/15/805f15509fe06d3748c019f8c4b2e00c.jpg", stats: { hp: 100, atk: 11, def: 10, spd: 9 }, moves: [{name: "Super Pugno", power: 1.4, description: "Un pugno con una forza incredibile."}, {name: "Visione Termica", power: 1.3, description: "Raggi di calore sparati dagli occhi."}, {name: "Invulnerabilità", power: 0, effect: 'invulnerability', effectDuration: [2, 2], uses: 3, description: "Diventa invulnerabile per 2 turni."}] },
            { id: 78, name: "Tanjiro", img: "https://i.pinimg.com/736x/b6/a0/64/b6a064006e8965bdd40128bbc8618a54.jpg", stats: { hp: 90, atk: 10, def: 8, spd: 10 }, moves: [{name: "Respirazione Acqua", power: 1.4, description: "Usa una delle forme della Respirazione dell'Acqua."}, {name: "Danza Dio del Fuoco", power: 1.6, effect: 'burn', effectChance: 0.4, effectDuration: [3, 4], description: "Un attacco potente che consuma energia e può scottare."}, {name: "Testata", power: 1.1, description: "Una testata sorprendentemente dura."}] },
            { id: 21, name: "Tecna", img: "https://i.pinimg.com/736x/dc/49/57/dc4957e6dc92728174b830bf39e8f70c.jpg", stats: { hp: 85, atk: 9, def: 9, spd: 10 }, moves: [{name: "Firewall", power: 0, effect: 'invulnerability', effectDuration: [2, 2], uses: 3, description: "Diventa invulnerabile per 2 turni."}, {name: "Raggio Digitale", power: 1.3, description: "Un raggio di pura energia tecnologica."}, {name: "Tecno-Trappola", power: 1.1, effect: 'stun', effectChance: 0.7, effectDuration: [2,2], uses: 3, description: "Una trappola che blocca il nemico."}] },
            { id: 53, name: "Tigre", img: "https://i.pinimg.com/736x/d0/27/88/d027883c4433588403dba9de4aa05eef.jpg", stats: { hp: 90, atk: 11, def: 8, spd: 10 }, moves: [{name: "Artigli di Fuoco", power: 1.4, description: "Colpi così veloci da sembrare infuocati."}, {name: "Balzo Felino", power: 1.2, description: "Balza sul nemico con ferocia."}, {name: "Stile della Tigre", power: 1.3, description: "Una serie di colpi potenti e aggraziati."}] },
            { id: 81, name: "Tom", img: "https://i.pinimg.com/736x/b6/78/03/b67803378ba3c26bfc4b7168d5b3e5ad.jpg", stats: { hp: 85, atk: 9, def: 7, spd: 9 }, moves: [{name: "Trappola per Topi", power: 1.2, effect: 'poison', effectChance: 0.5, description: "Piazza una trappola che scatta e può avvelenare."}, {name: "Inseguimento Folle", power: 0, damage: [15,15], description: "Una carica caotica e distruttiva che infligge 15 danni."}, {name: "Artigli Felini", power: 0, damage: [8,8], description: "Infligge 8 danni con i suoi artigli."}] },
            { id: 47, name: "Uncle Grandpa", img: "https://i.pinimg.com/736x/07/ee/87/07ee872f5009c41d6be260e17e6b1753.jpg", stats: { hp: 100, atk: 9, def: 9, spd: 7 }, moves: [{name: "Buongiorno!", power: 1.2, description: "Un saluto così entusiasta da fare danni."}, {name: "Evoca Marsupio", power: 1.3, description: "Tira fuori qualcosa di casuale dal marsupio."}, {name: "Realtà Alterata", power: 1.5, description: "Altera la realtà in modo imprevedibile."}] },
            { id: 63, name: "Wanda", img: "https://i.pinimg.com/1200x/fd/b3/ba/fdb3bada328ff3eb5aff2cc8c5bc92d1.jpg", stats: { hp: 82, atk: 9, def: 8, spd: 8 }, moves: [{name: "Magia Romantica", power: 0, effect: 'infatuation', effectChance: 1.0, effectDuration: [3, 3], uses: 3, description: "Infatua il nemico per 3 turni."}, {name: "Magia Potente", power: 0, damage: [12, 16], description: "Infligge da 12 a 16 danni magici."}, {name: "Figliolo", power: 0, effect: 'heal_percent', healPercent: 0.5, uses: 4, description: "Viene curata del 50% dei suoi HP massimi."}] },
            { id: 68, name: "Wonder Woman", img: "https://i.pinimg.com/736x/25/7a/a6/257aa66c1704bc9c14787e3391a6234a.jpg", stats: { hp: 95, atk: 11, def: 10, spd: 9 }, moves: [{name: "Lazo della Verità", power: 1.2, effect: 'stun', effectChance: 0.6, effectDuration: [2,2], uses: 3, description: "Cattura e blocca il nemico."}, {name: "Bracciali della Sottomissione", power: 0, effect: 'reflect', description: "Respinge un attacco nemico."}, {name: "Colpo Amazzone", power: 1.5, description: "Un potente attacco intriso di forza divina."}] },
            { id: 99, name: "Yoshi", img: "https://i.pinimg.com/736x/d8/fb/b2/d8fbb2ed4486c9d8631291e931e641aa.jpg", stats: { hp: 90, atk: 9, def: 9, spd: 8 }, moves: [{name: "Linguaccia", power: 1.2, description: "Ingoia il nemico e lo risputa."}, {name: "Salto a Terra", power: 1.3, description: "Un potente schianto a terra."}, {name: "Lancio di Uova", power: 1.1, description: "Lancia un uovo che esplode all'impatto."}] },
            { id: 65, name: "Yuko", img: "https://i.pinimg.com/736x/d5/54/18/d5541847c4fd0f22b49062782b88fb9d.jpg", stats: { hp: 85, atk: 9, def: 8, spd: 10 }, moves: [{name: "Anello Magico", power: 1.3, description: "Usa il suo anello per un attacco energetico."}, {name: "Volo Elfico", power: 0, effect: 'invulnerability', effectDuration: [2, 2], uses: 3, description: "Diventa invulnerabile per 2 turni."}, {name: "Strategia Astuta", power: 0, effect: 'atk_up', description: "Pianifica una mossa che aumenta il suo attacco."}] },
            { id: 35, name: "Zatch Bell", img: "https://i.pinimg.com/1200x/35/9c/9e/359c9e3e0530e20c95754847066e8167.jpg", stats: { hp: 85, atk: 11, def: 7, spd: 8 }, moves: [{name: "Zaker", power: 1.3, description: "Un fulmine che esce dalla bocca."}, {name: "Rashield", power: 0, effect: 'reflect_damage', uses: 3, description: "Uno scudo che respinge il danno subito al nemico."}, {name: "Zakeruga", power: 1.6, description: "Un raggio di fulmini concentrato e potente."}] },
            { id: 72, name: "Zuko", img: "https://i.pinimg.com/736x/f3/ac/60/f3ac60495d1922cc97723975473b7c8d.jpg", stats: { hp: 90, atk: 11, def: 8, spd: 9 }, moves: [{name: "Dominio del Fuoco", power: 1.4, effect: 'burn', effectChance: 0.4, effectDuration: [3, 4], effectDamage: [3, 6], description: "Un attacco con le fiamme che può scottare."}, {name: "Spade Doppie", power: 1.3, description: "Un rapido attacco con le sue spade."}, {name: "Redirezione Fulmine", power: 1.6, effect: 'counter', description: "Rispedisce al mittente un attacco energetico."}] },
            // NUOVI PERSONAGGI
            { id: 101, name: "Polli kung fu", img: "https://i.pinimg.com/736x/90/0c/19/900c194539f68a3941de9c09a024905b.jpg", stats: { hp: 90, atk: 10, def: 9, spd: 9 }, isNew: true, moves: [{name: "Sfera di energia verde", power: 0, damage: [15,15], effect: 'stun', effectChance: 0.4, effectDuration: [1, 1], description: "Fa 15 di danno e ha probabilità del 40% di stunnare per 1 turno."}, {name: "Pettine rampino", power: 0, effect: 'invulnerability', effectDuration: [1, 1], uses: 2, description: "Invulnerabilità per 1 turno."}, {name: "Ventagli e bastoni", power: 0, damage: [10, 14], effect: 'infatuation', effectChance: 0.5, effectDuration: [2, 2], description: "Infligge da 10 a 14 di danno con 50% di chance di infatuazione per 2 turni."}] },
            { id: 102, name: "Rick", img: "https://i.pinimg.com/736x/3b/04/4d/3b044de0cd2c10d754321af4ec18cd5f.jpg", stats: { hp: 80, atk: 12, def: 6, spd: 10 }, isNew: true, moves: [{name: "Portale dimensionale", power: 0, damage: [10,10], effect: 'stun', effectDuration: [2, 2], uses: 2, description: "Infligge 10 di danno e stordisce per due turni il nemico."}, {name: "Bevi-scienza", power: 0, effect: 'heal', healAmount: [13, 19], uses: 3, description: "Cura di 13-19 hp."}, {name: "Robot improvvisato", power: 0, damage: [7, 10], description: "Infligge da 7 a 10 di danno."}] },
            { id: 103, name: "Morty", img: "https://i.pinimg.com/736x/95/5c/dc/955cdc707097b8546e167c2188c4b5df.jpg", stats: { hp: 85, atk: 7, def: 8, spd: 9 }, isNew: true, moves: [{name: "Botta di fortuna", power: 0, effect: 'special_damage', description: "Puo' infliggere 1, 10, o 15 di danno."}, {name: "Rick aiuto!", power: 0, effect: 'invulnerability', effectDuration: [2, 2], uses: 5, description: "Si nasconde cercando Rick, invulnerabilità per 2 turni."}, {name: "Rabbia repressa", power: 0, damage: [7, 12], description: "Infligge da 7 a 12 di danno."}] },
            { id: 104, name: "Concetta's Dog", img: "https://placehold.co/100x100/ef4444/ffffff?text=Cane", stats: { hp: 90, atk: 9, def: 9, spd: 8 }, isNew: true, moves: [{name: "Hey belloccio<3", power: 0, effect: 'infatuation', effectChance: 1.0, effectDuration: [3, 3], uses: 2, description: "Infatua il nemico per 3 turni."}, {name: "Ariana Grande; Attivazione", power: 0, damage: [12, 16], description: "Infligge da 12 a 16 di danno."}, {name: "Peli di chiappe aumma", power: 0, effect: 'poison', effectChance: 1.0, effectDuration: [3,4], effectDamage: [4,6], description: "Avvelena il nemico."}] },
            { id: 105, name: "Camilla", img: "https://i.pinimg.com/1200x/e3/82/72/e382726630f62a8a716009aab16cafc6.jpg", stats: { hp: 95, atk: 11, def: 8, spd: 7 }, isNew: true, moves: [{name: "Vai, Garchomp!", power: 0, damage: [20, 20], uses: 2, description: "Il suo Garchomp colpisce il bersaglio, facendo 20 di danno."}, {name: "Milotic, Ripresa!", power: 0, effect: 'heal', healAmount: [30, 30], uses: 1, description: "Recupera 30 hp."}, {name: "Spiritomb, Palla Ombra!", power: 0, damage: [14, 16], description: "Infligge da 14 a 16 danni."}] },
            { id: 106, name: "Ganyu", img: "https://i.pinimg.com/736x/46/db/7e/46db7e6db045ac28eff3a551e7754d50.jpg", stats: { hp: 80, atk: 11, def: 6, spd: 10 }, isNew: true, moves: [{name: "Freccia del fiocco di neve", power: 0, damage: [6, 10], effect: 'freeze', effectChance: 0.3, effectDuration: [2, 2], description: "30% di chance di congelare per 2 turni."}, {name: "Tiro Plenilunare", power: 0, damage: [10, 10], effect: 'special_conditional_damage', description: "Infligge 10 di danno, o 20 se il bersaglio è congelato."}, {name: "Sentiero del Qilin", power: 0, effect: 'invulnerability', effectDuration: [1, 1], uses: 3, description: "Invulnerabilità per 1 turno."}] },
            { id: 107, name: "Crash", img: "https://i.pinimg.com/736x/98/e7/25/98e7251ed569efffda255ab33c0ffb11.jpg", stats: { hp: 88, atk: 9, def: 8, spd: 11 }, isNew: true, moves: [{name: "Vortice Giravolta", power: 0, damage: [11, 13], effect: 'stun', effectChance: 0.3, effectDuration: [1, 1], description: "30% di stordire per un turno."}, {name: "Scivolata Wumpa", power: 0, damage: [8, 12], description: "Scivola sotto i nemici infliggendo da 8 a 12 danni."}, {name: "Panciata Distruttiva", power: 0, damage: [15, 15], uses: 3, description: "Infligge 15 di danno."}, {name: "Maschera Aku Aku", power: 0, effect: 'invulnerability', effectDuration: [1, 1], uses: 1, description: "Diventa invulnerabile per 1 turno."}] },
            { id: 108, name: "Mia", img: "https://i.pinimg.com/736x/f0/5b/f1/f05bf1f89011521e38e5729e6cb9596f.jpg", stats: { hp: 85, atk: 8, def: 8, spd: 9 }, isNew: true, moves: [{name: "Luce di Elvenia", power: 0, damage: [7, 9], effect: 'cleanse', description: "Infligge danno e ti cura da qualsiasi effetto di stato."}, {name: "Onchao pensaci tu!", power: 0, damage: [11, 14], description: "Onchao infligge da 11 a 14 danni al bersaglio."}, {name: "Lacrima dell'unicorno", power: 0, effect: 'heal', healAmount: [8, 14], uses: 6, description: "Si cura da 8 a 14 hp."}] },
            { id: 109, name: "Ametista", img: "https://i.pinimg.com/736x/11/b5/05/11b5056b41f87fbe3120b68ed5dcfb09.jpg", stats: { hp: 92, atk: 10, def: 10, spd: 6 }, isNew: true, moves: [{name: "Frusta gemmata", power: 0, damage: [6, 12], effect: 'burn', effectChance: 0.6, effectDuration: [3,4], effectDamage: [4,6], description: "60% di chance di bruciare il bersaglio."}, {name: "Rotolamento distruttivo", power: 0, damage: [8, 15], description: "Infligge da 8 a 15 di danno."}, {name: "Rigenerazione rapida", power: 0, effect: 'heal_percent', healPercent: 0.25, uses: 3, description: "Si cura del 25% degli HP massimi."}] },
            { id: 110, name: "Mewtwo", img: "https://i.pinimg.com/1200x/14/58/63/145863e7d3907cda7d679130e0066014.jpg", stats: { hp: 90, atk: 13, def: 7, spd: 11 }, isNew: true, moves: [{name: "Psicobotta", power: 0, damage: [20, 20], effect: 'stun', effectDuration: [1, 1], uses: 2, description: "20 di danno, stordisce il bersaglio per 1 turno."}, {name: "Psichico", power: 0, damage: [10, 15], effect: 'stun', effectChance: 0.5, effectDuration: [1,1], description: "50% di stordire il bersaglio."}, {name: "Geloraggio", power: 0, damage: [6, 11], effect: 'freeze', effectChance: 0.5, effectDuration: [2,2], description: "50% di chance di congelare il bersaglio."}] },
        ];

        // Ordina il roster alfabeticamente
        charactersDB.sort((a, b) => a.name.localeCompare(b.name));

        const teamColors = [
            { name: 'Red', hex: '#ef4444' }, { name: 'Blue', hex: '#3b82f6' }, { name: 'Green', hex: '#22c55e' },
            { name: 'Yellow', hex: '#eab308' }, { name: 'Purple', hex: '#a855f7' }, { name: 'Pink', hex: '#ec4899' },
            { name: 'Indigo', hex: '#6366f1' }, { name: 'Teal', hex: '#14b8a6' },
            { name: 'Orange', hex: '#f97316' }, { name: 'Lime', hex: '#84cc16' }, { name: 'Emerald', hex: '#10b981' },
            { name: 'Cyan', hex: '#06b6d4' }, { name: 'Sky', hex: '#0ea5e9' }, { name: 'Violet', hex: '#8b5cf6' },
            { name: 'Fuchsia', hex: '#d946ef' }, { name: 'Rose', hex: '#f43f5e' }
        ];

        // --- STATO GLOBALE ---
        let globalState = {
            currentScreen: 'loading',
            userId: null, nickname: '', gameId: null, gameData: null,
            error: null, isLoading: false,
        };

        // --- FUNZIONI DI GIOCO ---
        let unsubscribeFromGame = null;

        const generateRoomCode = () => Math.random().toString(36).substring(2, 8).toUpperCase();

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                globalState.userId = user.uid;
                const storedNickname = localStorage.getItem('battagliaRoyaleNickname');
                globalState.nickname = storedNickname || '';
                globalState.currentScreen = storedNickname ? 'menu' : 'nickname';
            } else {
                try {
                    await signInAnonymously(auth);
                } catch (error) {
                    console.error("Authentication Error:", error);
                    globalState.error = "Impossibile connettersi al server di gioco.";
                }
            }
            render();
        });

        async function createGame() {
            globalState.isLoading = true; render();
            const gameId = generateRoomCode();
            const gameRef = doc(db, `artifacts/${appId}/public/data/battaglia-royale`, gameId);
            const initialGameData = {
                hostId: globalState.userId, status: 'config', createdAt: new Date(),
                config: { numTeams: 2, membersPerTeam: 4 },
                players: {
                    [globalState.userId]: { nickname: globalState.nickname, isCPU: false, teamName: '', teamColor: null, characters: [], eliminated: false, kills: 0, ready: false, eliminatedInRound: null }
                },
                draftState: null, arenaState: null,
            };
            try {
                await setDoc(gameRef, initialGameData);
                globalState.gameId = gameId;
                listenToGame(gameId);
            } catch (error) {
                console.error("Error creating room:", error);
                globalState.error = "Impossibile creare la stanza. Riprova.";
                globalState.isLoading = false; render();
            }
        }

        async function joinGame(gameId) {
            globalState.isLoading = true; render();
            const gameRef = doc(db, `artifacts/${appId}/public/data/battaglia-royale`, gameId);
            try {
                const gameSnap = await getDoc(gameRef);
                if (!gameSnap.exists()) throw new Error("Stanza non trovata.");
                const gameData = gameSnap.data();
                if (Object.keys(gameData.players).length >= gameData.config.numTeams) throw new Error("La stanza è piena.");
                const playerUpdate = {
                    [`players.${globalState.userId}`]: { nickname: globalState.nickname, isCPU: false, teamName: '', teamColor: null, characters: [], eliminated: false, kills: 0, ready: false, eliminatedInRound: null }
                };
                await updateDoc(gameRef, playerUpdate);
                globalState.gameId = gameId;
                listenToGame(gameId);
            } catch (error) {
                console.error("Error joining room:", error);
                globalState.error = error.message;
                globalState.isLoading = false; globalState.currentScreen = 'menu'; render();
            }
        }
        
        async function initializeDraft() {
            const { players, config } = globalState.gameData;
            const playerIds = Object.keys(players);
            const draftState = {
                playerOrder: playerIds, currentPlayerIndex: 0, picksMade: 0,
                totalPicks: playerIds.length * config.membersPerTeam,
                availableCharacterIds: charactersDB.map(c => c.id),
            };
            await updateDoc(doc(db, `artifacts/${appId}/public/data/battaglia-royale`, globalState.gameId), { status: 'drafting', draftState: draftState });
        }
        
        async function selectCharacter(characterId) {
            const { draftState, players } = globalState.gameData;
            const currentPlayerId = draftState.playerOrder[draftState.currentPlayerIndex];
            if (globalState.userId !== currentPlayerId && !players[currentPlayerId].isCPU) return;
            if (!draftState.availableCharacterIds.includes(characterId)) return;
            globalState.isLoading = true; render();
            const gameRef = doc(db, `artifacts/${appId}/public/data/battaglia-royale`, globalState.gameId);
            const updates = {};
            const playerCharacters = players[currentPlayerId].characters || [];
            updates[`players.${currentPlayerId}.characters`] = [...playerCharacters, { id: characterId, status: 'active', specialUses: {} }];
            updates['draftState.availableCharacterIds'] = draftState.availableCharacterIds.filter(id => id !== characterId);
            const newPicksMade = draftState.picksMade + 1;
            updates['draftState.picksMade'] = newPicksMade;
            if (newPicksMade >= draftState.totalPicks) {
                updates['status'] = 'naming';
                updates['draftState'] = null;
            } else {
                updates['draftState.currentPlayerIndex'] = (draftState.currentPlayerIndex + 1) % draftState.playerOrder.length;
            }
            try {
                await updateDoc(gameRef, updates);
            } catch(e) {
                console.error("Errore nella selezione:", e);
                globalState.isLoading = false; render();
            }
        }
        
        function handleCPUTurn() {
            const { draftState, players } = globalState.gameData;
            if (!draftState) return;
            const currentPlayerId = draftState.playerOrder[draftState.currentPlayerIndex];
            const currentPlayer = players[currentPlayerId];
            if (currentPlayer && currentPlayer.isCPU) {
                setTimeout(() => {
                    const availableIds = draftState.availableCharacterIds;
                    if (availableIds.length > 0) {
                        const randomIndex = Math.floor(Math.random() * availableIds.length);
                        selectCharacter(availableIds[randomIndex]);
                    }
                }, 1500);
            }
        }
        
        async function handleCPUNaming() {
            const { players } = globalState.gameData;
            const cpuTeamNames = ["Team Dominio", "Squadra Omega", "Cyber Guerrieri", "Falangi d'Acciaio", "I Distruttori"];
            let usedColors = Object.values(players).map(p => p.teamColor).filter(Boolean);
            for (const playerId in players) {
                const player = players[playerId];
                if (player.isCPU && !player.ready) {
                    const availableColors = teamColors.filter(c => !usedColors.includes(c.hex));
                    const chosenColor = availableColors.length > 0 ? availableColors[Math.floor(Math.random() * availableColors.length)].hex : null;
                    const chosenName = cpuTeamNames[Math.floor(Math.random() * cpuTeamNames.length)];
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/battaglia-royale`, globalState.gameId), {
                        [`players.${playerId}.teamName`]: chosenName,
                        [`players.${playerId}.teamColor`]: chosenColor,
                        [`players.${playerId}.ready`]: true,
                    });
                    if(chosenColor) usedColors.push(chosenColor);
                }
            }
        }

        async function startNewRound() {
            const { players, arenaState } = globalState.gameData;
            const gameRef = doc(db, `artifacts/${appId}/public/data/battaglia-royale`, globalState.gameId);
            const newRound = arenaState ? arenaState.round + 1 : 1;
            const newLog = arenaState ? [...arenaState.log, `Inizia il Round ${newRound}!`] : ["Il torneo ha inizio!"];
            
            await updateDoc(gameRef, {
                status: 'fighting',
                'arenaState.status': 'revealing_teams',
                'arenaState.round': newRound,
                'arenaState.log': newLog
            });

            setTimeout(async () => {
                const activePlayerIds = Object.keys(players).filter(id => !players[id].eliminated);
                if(activePlayerIds.length < 2) return;
                const team1Index = Math.floor(Math.random() * activePlayerIds.length);
                let team2Index;
                do { team2Index = Math.floor(Math.random() * activePlayerIds.length); } while (team1Index === team2Index);
                const fightingTeamIds = [activePlayerIds[team1Index], activePlayerIds[team2Index]];
                const team1Name = players[fightingTeamIds[0]].teamName;
                const team2Name = players[fightingTeamIds[1]].teamName;
                await updateDoc(gameRef, {
                    'arenaState.status': 'selecting_fighters',
                    'arenaState.fightingTeams': fightingTeamIds,
                    'arenaState.currentFighters': {},
                    'arenaState.log': [...globalState.gameData.arenaState.log, `Il fato ha scelto: ${team1Name} contro ${team2Name}!`]
                });
            }, 3000);
        }

        function listenToGame(gameId) {
            if (unsubscribeFromGame) unsubscribeFromGame();
            const gameRef = doc(db, `artifacts/${appId}/public/data/battaglia-royale`, gameId);
            unsubscribeFromGame = onSnapshot(gameRef, (doc) => {
                if (doc.exists()) {
                    const oldData = globalState.gameData;
                    globalState.gameData = doc.data();
                    globalState.isLoading = false;
                    const newStatus = globalState.gameData.status;
                    globalState.currentScreen = newStatus === 'waiting' ? 'lobby' : newStatus;
                    
                    if (newStatus === 'drafting' && oldData?.status !== 'drafting') handleCPUTurn();
                    else if (newStatus === 'drafting' && oldData?.draftState?.currentPlayerIndex !== globalState.gameData.draftState.currentPlayerIndex) handleCPUTurn();
                    
                    if (newStatus === 'naming' && oldData?.status !== 'naming') {
                        if (globalState.userId === globalState.gameData.hostId) handleCPUNaming();
                    } else if (newStatus === 'naming') {
                        const allReady = Object.values(globalState.gameData.players).every(p => p.ready);
                        if (allReady && globalState.userId === globalState.gameData.hostId) {
                           updateDoc(gameRef, { 'arenaState': { round: 0, log: [] } }).then(() => startNewRound());
                        }
                    }

                    if (newStatus === 'fighting' && globalState.userId === globalState.gameData.hostId) {
                        const { arenaState, players } = globalState.gameData;
                        if (arenaState.status === 'selecting_fighters') {
                            handleCPUFighterSelection();
                            if (Object.keys(arenaState.currentFighters).length === arenaState.fightingTeams.length) {
                                startTheFight();
                            }
                        }
                        else if (arenaState.status === 'fighting_dice') {
                            if (arenaState.diceRolls && Object.values(arenaState.diceRolls).every(v => v !== null)) {
                                setTimeout(() => processDiceFight(), 1000);
                            } else {
                                handleCPUDiceRoll();
                            }
                        } else if (arenaState.status === 'fighting_rpg' && arenaState.rpgBattle) {
                            if (arenaState.rpgBattle.phase === 'resolution') {
                                setTimeout(() => processTurnResolution(), 1000);
                            } else if (arenaState.rpgBattle.phase === 'action') {
                                const currentPlayerId = arenaState.rpgBattle.turn;
                                if (players[currentPlayerId] && players[currentPlayerId].isCPU) {
                                    handleCPURPGMove();
                                }
                            }
                        }
                    }
                } else {
                    leaveGame();
                    globalState.error = "La stanza è stata chiusa dall'host.";
                }
                render();
            });
        }

        async function leaveGame() {
            if (unsubscribeFromGame) { unsubscribeFromGame(); unsubscribeFromGame = null; }
            if (globalState.gameId && globalState.gameData) {
                const gameRef = doc(db, `artifacts/${appId}/public/data/battaglia-royale`, globalState.gameId);
                if (globalState.userId === globalState.gameData.hostId) {
                    try { await deleteDoc(gameRef); } catch (e) { console.error("Impossibile cancellare la partita", e)}
                } else {
                    try { await updateDoc(gameRef, { [`players.${globalState.userId}`]: deleteField() }); } catch(e) { console.error("Impossibile rimuovere il giocatore", e)}
                }
            }
            globalState.gameId = null; globalState.gameData = null; globalState.currentScreen = 'menu';
            render();
        }
        
        // --- LOGICA DI COMBATTIMENTO ---
        async function selectFighter(characterId) {
            const { arenaState } = globalState.gameData;
            if (arenaState.status !== 'selecting_fighters') return;
            const gameRef = doc(db, `artifacts/${appId}/public/data/battaglia-royale`, globalState.gameId);
            await updateDoc(gameRef, {
                [`arenaState.currentFighters.${globalState.userId}`]: characterId
            });
        }

        async function handleCPUFighterSelection() {
            const { arenaState, players } = globalState.gameData;
            const updates = {};
            
            for (const playerId of arenaState.fightingTeams) {
                if (players[playerId].isCPU && !arenaState.currentFighters[playerId]) {
                    const availableChars = players[playerId].characters.filter(c => c.status === 'active');
                    const randomChar = availableChars[Math.floor(Math.random() * availableChars.length)];
                    updates[`arenaState.currentFighters.${playerId}`] = randomChar.id;
                }
            }
            
            if (Object.keys(updates).length > 0) {
                await updateDoc(doc(db, `artifacts/${appId}/public/data/battaglia-royale`, globalState.gameId), updates);
            }
        }

        async function startTheFight() {
            const { arenaState, players } = globalState.gameData;
            const updates = {};
            const fightMode = Math.random() < 0.5 ? 'fighting_dice' : 'fighting_rpg';
            updates['arenaState.status'] = fightMode;
            const [p1Id, p2Id] = arenaState.fightingTeams;
            const fighter1 = charactersDB.find(c => c.id === arenaState.currentFighters[p1Id]);
            const fighter2 = charactersDB.find(c => c.id === arenaState.currentFighters[p2Id]);
            updates['arenaState.log'] = [...arenaState.log, `${fighter1.name} e ${fighter2.name} entrano in arena!`];

            if (fightMode === 'fighting_dice') {
                updates['arenaState.diceTurn'] = p1Id;
                updates['arenaState.diceRolls'] = { [p1Id]: null, [p2Id]: null };
            } else {
                // Determine turn order by speed
                const firstPlayer = fighter1.stats.spd > fighter2.stats.spd ? p1Id : (fighter2.stats.spd > fighter1.stats.spd ? p2Id : (Math.random() < 0.5 ? p1Id : p2Id));

                updates['arenaState.rpgBattle'] = {
                    turn: firstPlayer,
                    phase: 'action', 
                    chosenMoveIndex: null,
                    p1_id: p1Id, p2_id: p2Id,
                    p1_hp: fighter1.stats.hp, p2_hp: fighter2.stats.hp,
                    p1_max_hp: fighter1.stats.hp, p2_max_hp: fighter2.stats.hp,
                    p1_status: null, p2_status: null,
                    battleLog: ["Inizia la battaglia RPG!"]
                };
            }
            await updateDoc(doc(db, `artifacts/${appId}/public/data/battaglia-royale`, globalState.gameId), updates);
        }

        async function rollDice() {
            const { arenaState } = globalState.gameData;
            if (arenaState.diceTurn !== globalState.userId) return;
            const roll = Math.floor(Math.random() * 6) + 1;
            const otherPlayerId = arenaState.fightingTeams.find(id => id !== globalState.userId);
            await updateDoc(doc(db, `artifacts/${appId}/public/data/battaglia-royale`, globalState.gameId), {
                [`arenaState.diceRolls.${globalState.userId}`]: roll,
                'arenaState.diceTurn': otherPlayerId
            });
        }

        function handleCPUDiceRoll() {
            const { arenaState, players } = globalState.gameData;
            const cpuId = arenaState.diceTurn;
            if (players[cpuId] && players[cpuId].isCPU && arenaState.diceRolls[cpuId] === null) {
                setTimeout(async () => {
                    const roll = Math.floor(Math.random() * 6) + 1;
                    const otherPlayerId = arenaState.fightingTeams.find(id => id !== cpuId);
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/battaglia-royale`, globalState.gameId), {
                        [`arenaState.diceRolls.${cpuId}`]: roll,
                        'arenaState.diceTurn': otherPlayerId
                    });
                }, 2000);
            }
        }
        
        async function processDiceFight() {
            if (globalState.userId !== globalState.gameData.hostId || globalState.gameData.arenaState.status !== 'fighting_dice') return;

            const { arenaState } = globalState.gameData;
            const [player1Id, player2Id] = arenaState.fightingTeams;
            const roll1 = arenaState.diceRolls[player1Id];
            const roll2 = arenaState.diceRolls[player2Id];

            if (roll1 === roll2) {
                await updateDoc(doc(db, `artifacts/${appId}/public/data/battaglia-royale`, globalState.gameId), {
                    'arenaState.diceRolls': { [player1Id]: null, [player2Id]: null },
                    'arenaState.diceTurn': player1Id,
                    'arenaState.log': [...arenaState.log, `Nulla di fatto! (${roll1} vs ${roll2}) Si lancia di nuovo!`]
                });
                return;
            }

            const winnerId = roll1 > roll2 ? player1Id : player2Id;
            const loserId = roll1 > roll2 ? player2Id : player1Id;
            
            await processFightEnd(winnerId, loserId, `Il dado è tratto! (${roll1} vs ${roll2})`);
        }

        async function handlePlayerMove(moveIndex) {
            const { arenaState, players, hostId } = globalState.gameData;
            const attackerId = arenaState.rpgBattle.turn;
            const isMyTurn = globalState.userId === attackerId;
            const isHost = globalState.userId === hostId;
            const attackerIsCpu = players[attackerId]?.isCPU;

            if (arenaState.rpgBattle.phase !== 'action') return;
            if (!isMyTurn && !(isHost && attackerIsCpu)) return;

            const attackerCharDB = charactersDB.find(c => c.id === arenaState.currentFighters[attackerId]);
            const move = attackerCharDB.moves[moveIndex];
            if (move.uses !== undefined) {
                 const attackerPlayer = players[attackerId];
                 const attackerCharInGame = attackerPlayer.characters.find(c => c.id === attackerCharDB.id);
                 const usesLeft = attackerCharInGame.specialUses[moveIndex] ?? move.uses;
                 if (usesLeft <= 0) return; // Move has no uses left
            }

            await updateDoc(doc(db, `artifacts/${appId}/public/data/battaglia-royale`, globalState.gameId), {
                'arenaState.rpgBattle.chosenMoveIndex': moveIndex,
                'arenaState.rpgBattle.phase': 'resolution'
            });
        }

        function handleCPURPGMove() {
            const { arenaState, players } = globalState.gameData;
            if (!arenaState.rpgBattle || arenaState.rpgBattle.phase !== 'action' || arenaState.rpgBattle.chosenMoveIndex !== null) {
                return;
            }
            const cpuId = arenaState.rpgBattle.turn;
            if (players[cpuId] && players[cpuId].isCPU) {
                 setTimeout(() => {
                    const cpuCharDB = charactersDB.find(c => c.id === arenaState.currentFighters[cpuId]);
                    const cpuPlayer = players[cpuId];
                    const cpuCharInGame = cpuPlayer.characters.find(c => c.id === cpuCharDB.id);
                    
                    const isP1 = arenaState.rpgBattle.p1_id === cpuId;
                    const hpPercent = (isP1 ? arenaState.rpgBattle.p1_hp / arenaState.rpgBattle.p1_max_hp : arenaState.rpgBattle.p2_hp / arenaState.rpgBattle.p2_max_hp) * 100;
                    
                    const validMoves = cpuCharDB.moves.map((move, index) => {
                        const usesLeft = move.uses !== undefined ? (cpuCharInGame.specialUses[index] ?? move.uses) : Infinity;
                        return { move, index, usesLeft };
                    }).filter(m => m.usesLeft > 0);

                    const healMoves = validMoves.filter(m => m.move.effect === 'heal' || m.move.effect === 'heal_percent' || m.move.effect === 'special_heal');

                    if (hpPercent < 40 && healMoves.length > 0) {
                        handlePlayerMove(healMoves[0].index);
                    } else {
                        const attackMoves = validMoves.filter(m => m.move.effect !== 'heal' && m.move.effect !== 'heal_percent' && m.move.effect !== 'special_heal');
                        if (attackMoves.length > 0) {
                            const randomAttack = attackMoves[Math.floor(Math.random() * attackMoves.length)];
                            handlePlayerMove(randomAttack.index);
                        }
                    }
                }, 2000);
            }
        }

        async function processTurnResolution() {
            if (globalState.userId !== globalState.gameData.hostId) return;

            const { arenaState, players } = globalState.gameData;
            let { rpgBattle } = arenaState;
            const updates = {};
            let newLog = [];

            const attackerId = rpgBattle.turn;
            const defenderId = attackerId === rpgBattle.p1_id ? rpgBattle.p2_id : rpgBattle.p1_id;
            
            const isAttackerP1 = attackerId === rpgBattle.p1_id;
            let attackerStatus = isAttackerP1 ? rpgBattle.p1_status : rpgBattle.p2_status;
            const isDefenderP1 = defenderId === rpgBattle.p1_id;
            let defenderStatus = isDefenderP1 ? rpgBattle.p1_status : rpgBattle.p2_status;
            
            const attackerCharDB = charactersDB.find(c => c.id === arenaState.currentFighters[attackerId]);
            const defenderCharDB = charactersDB.find(c => c.id === arenaState.currentFighters[defenderId]);

            let canAct = true;

            // 1. Process start-of-turn effects for the attacker
            if (attackerStatus) {
                if (attackerStatus.type === 'poison' || attackerStatus.type === 'burn' || attackerStatus.type === 'vortex') {
                    const dotDamage = Math.floor(Math.random() * (attackerStatus.damage[1] - attackerStatus.damage[0] + 1)) + attackerStatus.damage[0];
                    if (isAttackerP1) rpgBattle.p1_hp = Math.max(0, rpgBattle.p1_hp - dotDamage);
                    else rpgBattle.p2_hp = Math.max(0, rpgBattle.p2_hp - dotDamage);
                    newLog.push(`${attackerCharDB.name} subisce ${dotDamage} danni da ${attackerStatus.type}!`);
                    if ((isAttackerP1 && rpgBattle.p1_hp <= 0) || (!isAttackerP1 && rpgBattle.p2_hp <= 0)) {
                        await processFightEnd(defenderId, attackerId, `${attackerCharDB.name} è stato sconfitto dagli effetti!`);
                        return;
                    }
                }

                if (attackerStatus.type === 'freeze' || attackerStatus.type === 'stun' || attackerStatus.type === 'sleep') {
                    canAct = false;
                    newLog.push(`${attackerCharDB.name} è bloccato e non può muoversi!`);
                } else if (attackerStatus.type === 'infatuation') {
                    if (Math.random() < 0.5) {
                        canAct = false;
                        newLog.push(`${attackerCharDB.name} è infatuato e non attacca!`);
                    }
                }
            }

            // 2. Process the chosen move if the attacker can act
            if (canAct && rpgBattle.chosenMoveIndex !== null) {
                const move = attackerCharDB.moves[rpgBattle.chosenMoveIndex];
                
                newLog.push(`${attackerCharDB.name} usa ${move.name}!`);

                // Handle move uses
                if (move.uses !== undefined) {
                    let attackerChars = JSON.parse(JSON.stringify(players[attackerId].characters));
                    const charInGameIndex = attackerChars.findIndex(c => c.id === attackerCharDB.id);
                    let currentUses = attackerChars[charInGameIndex].specialUses[rpgBattle.chosenMoveIndex] ?? move.uses;
                    currentUses--;
                    attackerChars[charInGameIndex].specialUses[rpgBattle.chosenMoveIndex] = currentUses;
                    updates[`players.${attackerId}.characters`] = attackerChars;
                }

                // Handle damage
                let damage = 0;
                if (move.effect === 'special_damage' && move.name === 'Botta di fortuna') {
                    const possibleDamage = [1, 10, 15];
                    damage = possibleDamage[Math.floor(Math.random() * possibleDamage.length)];
                    newLog.push(`La fortuna gira!`);
                } else if (move.effect === 'special_conditional_damage' && move.name === 'Tiro Plenilunare') {
                    damage = 10;
                    if (defenderStatus && defenderStatus.type === 'freeze') {
                        damage = 20;
                        newLog.push(`Colpisce il punto debole congelato!`);
                    }
                } else if (move.damage) {
                    damage = Math.floor(Math.random() * (move.damage[1] - move.damage[0] + 1)) + move.damage[0];
                } else if (move.power > 0) {
                    const baseDamage = attackerCharDB.stats.atk * move.power;
                    damage = Math.max(1, Math.floor(baseDamage - (defenderCharDB.stats.def * 0.5) + (Math.random() * 4 - 2)));
                }

                // Check if defender is invulnerable
                if (defenderStatus && defenderStatus.type === 'invulnerability') {
                    damage = 0;
                    newLog.push(`${defenderCharDB.name} è invulnerabile e non subisce danni!`);
                }

                if (damage > 0) {
                    if (isAttackerP1) rpgBattle.p2_hp = Math.max(0, rpgBattle.p2_hp - damage);
                    else rpgBattle.p1_hp = Math.max(0, rpgBattle.p1_hp - damage);
                    newLog.push(`Infligge ${damage} danni!`);
                }

                // Handle healing and other effects
                if (move.effect === 'cleanse') {
                    if (isAttackerP1 && rpgBattle.p1_status) {
                        newLog.push(`${attackerCharDB.name} si è purificato da ${rpgBattle.p1_status.type}!`);
                        rpgBattle.p1_status = null;
                    } else if (!isAttackerP1 && rpgBattle.p2_status) {
                        newLog.push(`${attackerCharDB.name} si è purificato da ${rpgBattle.p2_status.type}!`);
                        rpgBattle.p2_status = null;
                    }
                    attackerStatus = null; // Update local variable as well
                } else if (move.effect === 'special_random' && move.name === 'Idea Geniale, Forse (?)') {
                    if (Math.random() < 0.5) { // 50% chance to heal
                        const heal = 18;
                        if (isAttackerP1) rpgBattle.p1_hp = Math.min(rpgBattle.p1_max_hp, rpgBattle.p1_hp + heal);
                        else rpgBattle.p2_hp = Math.min(rpgBattle.p2_max_hp, rpgBattle.p2_hp + heal);
                        newLog.push(`${attackerCharDB.name} ha un'idea geniale e recupera ${heal} HP!`);
                    } else { // 50% chance to deal damage
                        const specialDamage = 12;
                        if (defenderStatus && defenderStatus.type === 'invulnerability') {
                            newLog.push(`L'idea di ${attackerCharDB.name} fallisce! ${defenderCharDB.name} è invulnerabile!`);
                        } else {
                            if (isAttackerP1) rpgBattle.p2_hp = Math.max(0, rpgBattle.p2_hp - specialDamage);
                            else rpgBattle.p1_hp = Math.max(0, rpgBattle.p1_hp - specialDamage);
                            newLog.push(`L'idea di ${attackerCharDB.name} è un disastro e infligge ${specialDamage} danni!`);
                        }
                    }
                } else if (move.effect === 'heal') {
                    const [min, max] = move.healAmount;
                    const heal = Math.floor(Math.random() * (max - min + 1)) + min;
                    if (isAttackerP1) rpgBattle.p1_hp = Math.min(rpgBattle.p1_max_hp, rpgBattle.p1_hp + heal);
                    else rpgBattle.p2_hp = Math.min(rpgBattle.p2_max_hp, rpgBattle.p2_hp + heal);
                    newLog.push(`${attackerCharDB.name} recupera ${heal} HP!`);
                } else if (move.effect === 'heal_percent') {
                    const max_hp = isAttackerP1 ? rpgBattle.p1_max_hp : rpgBattle.p2_max_hp;
                    const heal = Math.floor(max_hp * move.healPercent);
                    if (isAttackerP1) rpgBattle.p1_hp = Math.min(rpgBattle.p1_max_hp, rpgBattle.p1_hp + heal);
                    else rpgBattle.p2_hp = Math.min(rpgBattle.p2_max_hp, rpgBattle.p2_hp + heal);
                    newLog.push(`${attackerCharDB.name} recupera ${heal} HP!`);
                } else if (move.effect === 'lifesteal') {
                    const heal = move.healAmount ? move.healAmount : damage;
                    if (isAttackerP1) rpgBattle.p1_hp = Math.min(rpgBattle.p1_max_hp, rpgBattle.p1_hp + heal);
                    else rpgBattle.p2_hp = Math.min(rpgBattle.p2_max_hp, rpgBattle.p2_hp + heal);
                    newLog.push(`${attackerCharDB.name} recupera ${heal} HP!`);
                } else if (move.effect === 'lifesteal_percent') {
                    const heal = Math.floor(damage * move.healPercent);
                    if (isAttackerP1) rpgBattle.p1_hp = Math.min(rpgBattle.p1_max_hp, rpgBattle.p1_hp + heal);
                    else rpgBattle.p2_hp = Math.min(rpgBattle.p2_max_hp, rpgBattle.p2_hp + heal);
                    newLog.push(`${attackerCharDB.name} recupera ${heal} HP!`);
                } else if (move.effect === 'halve_hp') {
                    if (isAttackerP1) rpgBattle.p2_hp = Math.max(1, Math.floor(rpgBattle.p2_hp - (rpgBattle.p2_max_hp * 0.5)));
                    else rpgBattle.p1_hp = Math.max(1, Math.floor(rpgBattle.p1_hp - (rpgBattle.p1_max_hp * 0.5)));
                    newLog.push(`Gli HP di ${defenderCharDB.name} sono stati dimezzati!`);
                }
                
                // Handle status effects
                let moveEffect = move.effect;
                if (move.effect === 'random_status') {
                    const possibleStatuses = ['poison', 'burn', 'freeze', 'stun', 'infatuation', 'sleep'];
                    moveEffect = possibleStatuses[Math.floor(Math.random() * possibleStatuses.length)];
                    newLog.push(`L'invenzione ha un effetto ${moveEffect}!`);
                }

                // Handle self-inflicted statuses like invulnerability
                if (moveEffect === 'invulnerability') {
                    const duration = Math.floor(Math.random() * (move.effectDuration[1] - move.effectDuration[0] + 1)) + move.effectDuration[0];
                    const newStatus = { type: 'invulnerability', duration: duration + 1 }; // +1 because it decrements at end of this turn
                    if (isAttackerP1) rpgBattle.p1_status = newStatus;
                    else rpgBattle.p2_status = newStatus;
                    newLog.push(`${attackerCharDB.name} diventa invulnerabile!`);
                    attackerStatus = newStatus; // Update attackerStatus for the end-of-turn cleanup
                }

                const statusApplicable = ['poison', 'burn', 'freeze', 'stun', 'infatuation', 'sleep', 'vortex'].includes(moveEffect);

                if (statusApplicable && (Math.random() < (move.effectChance || 1.0))) {
                    const statusParams = {
                        poison: { duration: [3, 4], damage: [3, 5] },
                        burn: { duration: [3, 4], damage: [4, 6] },
                        freeze: { duration: [2, 2] },
                        stun: { duration: [1, 1] },
                        infatuation: { duration: [3, 3] },
                        sleep: { duration: [3, 3] },
                        vortex: { duration: [5, 5], damage: [5, 5] }
                    };
                    
                    const params = move.effectDuration ? { duration: move.effectDuration, damage: move.effectDamage } : statusParams[moveEffect];
                    
                    const newStatus = {
                        type: moveEffect,
                        duration: Math.floor(Math.random() * (params.duration[1] - params.duration[0] + 1)) + params.duration[0],
                    };
                    if (params.damage) newStatus.damage = params.damage;
                    
                    if (isAttackerP1) rpgBattle.p2_status = newStatus;
                    else rpgBattle.p1_status = newStatus;
                    newLog.push(`${defenderCharDB.name} ora è affetto da ${newStatus.type}!`);
                }
                
                if ((isAttackerP1 && rpgBattle.p2_hp <= 0) || (!isAttackerP1 && rpgBattle.p1_hp <= 0)) {
                    await processFightEnd(attackerId, defenderId, `La battaglia è stata vinta!`);
                    return;
                }
            }
            
            // 3. End of turn cleanup
            if (attackerStatus) {
                attackerStatus.duration--;
                if (attackerStatus.duration <= 0) {
                    newLog.push(`${attackerCharDB.name} non è più affetto da ${attackerStatus.type}.`);
                    attackerStatus = null;
                }
            }
            
            if (isAttackerP1) rpgBattle.p1_status = attackerStatus;
            else rpgBattle.p2_status = attackerStatus;

            rpgBattle.turn = defenderId; // Switch turn
            rpgBattle.phase = 'action'; // Wait for next player's input
            rpgBattle.chosenMoveIndex = null;
            rpgBattle.battleLog = [...rpgBattle.battleLog, ...newLog];

            updates['arenaState.rpgBattle'] = rpgBattle;
            await updateDoc(doc(db, `artifacts/${appId}/public/data/battaglia-royale`, globalState.gameId), updates);
        }

        async function processFightEnd(winnerId, loserId, reason) {
            const { arenaState, players } = globalState.gameData;
            const winnerChar = charactersDB.find(c => c.id === arenaState.currentFighters[winnerId]);
            const loserChar = charactersDB.find(c => c.id === arenaState.currentFighters[loserId]);
            
            const updates = {};
            const loserTeamChars = players[loserId].characters.map(char => char.id === loserChar.id ? { ...char, status: 'defeated' } : char);
            updates[`players.${loserId}.characters`] = loserTeamChars;
            updates[`players.${winnerId}.kills`] = (players[winnerId].kills || 0) + 1;
            
            const newLog = [...arenaState.log, `${winnerChar.name} (${players[winnerId].nickname}) ha sconfitto ${loserChar.name} (${players[loserId].nickname}). ${reason}`];
            
            const loserTeamHasMembers = loserTeamChars.some(c => c.status === 'active');
            if (!loserTeamHasMembers) {
                updates[`players.${loserId}.eliminated`] = true;
                updates[`players.${loserId}.eliminatedInRound`] = arenaState.round;
                newLog.push(`Il team ${players[loserId].teamName} è stato eliminato! BOOM!`);
            }

            const activeTeams = Object.keys(players).filter(pId => {
                if (pId === loserId) return loserTeamHasMembers;
                return !players[pId].eliminated;
            });

            if (activeTeams.length <= 1) {
                const winningTeam = players[activeTeams[0]];
                updates['status'] = 'finished';
                updates['arenaState'] = { ...arenaState, log: [...newLog, `IL TEAM ${winningTeam.teamName.toUpperCase()} HA VINTO IL TORNEO!`] };
                await updateDoc(doc(db, `artifacts/${appId}/public/data/battaglia-royale`, globalState.gameId), updates);
            } else {
                updates['arenaState.status'] = 'round_over';
                updates['arenaState.log'] = newLog;
                updates['arenaState.rpgBattle'] = null; // Clear battle data
                await updateDoc(doc(db, `artifacts/${appId}/public/data/battaglia-royale`, globalState.gameId), updates);

                setTimeout(() => startNewRound(), 4000);
            }
        }
        
        async function forceNextAction() {
            if(globalState.userId !== globalState.gameData.hostId) return;
            const { arenaState, players } = globalState.gameData;
            
            let inactivePlayerId;
            switch(arenaState.status) {
                case 'selecting_fighters':
                    inactivePlayerId = arenaState.fightingTeams.find(id => !arenaState.currentFighters[id] && !players[id].isCPU);
                    if(inactivePlayerId) {
                        const otherPlayerId = arenaState.fightingTeams.find(id => id !== inactivePlayerId);
                        await processFightEnd(otherPlayerId, inactivePlayerId, "L'avversario non ha scelto un combattente in tempo!");
                    }
                    break;
                case 'fighting_dice':
                    inactivePlayerId = arenaState.diceTurn;
                    if(!players[inactivePlayerId].isCPU) {
                        const winnerId = arenaState.fightingTeams.find(id => id !== inactivePlayerId);
                        await processFightEnd(winnerId, inactivePlayerId, "L'avversario non ha lanciato il dado in tempo!");
                    }
                    break;
                case 'fighting_rpg':
                    if (arenaState.rpgBattle.phase === 'action') {
                        inactivePlayerId = arenaState.rpgBattle.turn;
                         if(!players[inactivePlayerId].isCPU) {
                             const winnerId = arenaState.fightingTeams.find(id => id !== inactivePlayerId);
                             await processFightEnd(winnerId, inactivePlayerId, "L'avversario non ha eseguito una mossa in tempo!");
                         }
                    }
                    break;
            }
        }

        // --- FUNZIONI DI RENDERIZZAZIONE ---
        const appContainer = document.getElementById('app');

        function render() {
            appContainer.innerHTML = '';
            if (globalState.isLoading) { appContainer.innerHTML = renderLoading(); return; }
            if (globalState.error) {
                const errorDiv = document.createElement('div');
                errorDiv.className = "fixed top-5 right-5 bg-blue-500 text-white p-4 rounded-lg shadow-lg z-50";
                errorDiv.textContent = globalState.error;
                document.body.appendChild(errorDiv); // Append to body to be on top of everything
                setTimeout(() => { globalState.error = null; if(document.body.contains(errorDiv)) errorDiv.remove(); }, 3000);
            }
            switch (globalState.currentScreen) {
                case 'loading': appContainer.innerHTML = renderLoading(); break;
                case 'nickname': appContainer.innerHTML = renderNicknameScreen(); break;
                case 'menu': appContainer.innerHTML = renderMenuScreen(); break;
                case 'config': appContainer.innerHTML = renderConfigScreen(); break;
                case 'lobby': appContainer.innerHTML = renderLobbyScreen(); break;
                case 'drafting': appContainer.innerHTML = renderDraftScreen(); break;
                case 'naming': appContainer.innerHTML = renderNamingScreen(); break;
                case 'fighting': appContainer.innerHTML = renderArenaScreen(); break;
                case 'finished': appContainer.innerHTML = renderFinishedScreen(); break;
                default: appContainer.innerHTML = `<h1>Schermata non trovata: ${globalState.currentScreen}</h1>`;
            }
            attachEventListeners();
        }

        function renderLoading() { return `<div class="text-center"><svg class="animate-spin h-10 w-10 text-blue-400 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><p class="mt-4 text-lg">Caricamento...</p></div>`; }
        function renderNicknameScreen() { return `<div class="w-full max-w-md mx-auto bg-gray-800 p-8 rounded-xl shadow-2xl"><h1 class="text-4xl font-black text-center mb-2 text-blue-400">BENVENUTO!</h1><p class="text-center text-gray-400 mb-8">Scegli il tuo nome per la battaglia.</p><form id="nickname-form"><input type="text" id="nickname-input" class="w-full bg-gray-700 border-2 border-gray-600 rounded-lg p-3 text-center text-lg focus:outline-none focus:border-blue-500" placeholder="Il tuo nickname..." required maxlength="15"><button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg mt-4 text-lg btn-glow">Entra nell'Arena</button></form></div>`; }
        function renderMenuScreen() { return `<div class="w-full max-w-md mx-auto text-center"><h1 class="text-6xl font-black text-white mb-2">BATTAGLIA<span class="text-blue-400">ROYALE</span></h1><p class="text-gray-300 mb-10">Ciao, <span class="font-bold text-blue-400">${globalState.nickname}</span>! Cosa vuoi fare?</p><div class="space-y-4"><button id="create-game-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-4 rounded-lg text-xl btn-glow">Crea Stanza</button><div class="flex space-x-4"><input type="text" id="join-code-input" class="flex-grow bg-gray-700 border-2 border-gray-600 rounded-lg p-3 text-center focus:outline-none focus:border-blue-500" placeholder="CODICE STANZA"><button id="join-game-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg text-lg btn-glow">Unisciti</button></div><button id="find-game-btn" class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 px-4 rounded-lg text-lg btn-glow" disabled>Cerca Stanza (Prossimamente)</button></div></div>`; }
        function renderConfigScreen() { const { config } = globalState.gameData; return `<div class="w-full max-w-2xl mx-auto bg-gray-800 p-8 rounded-xl shadow-2xl"><h2 class="text-3xl font-bold text-center mb-6">Configurazione Partita</h2><div class="space-y-6"><div><label class="block text-lg font-medium text-gray-300 mb-2">Numero di Team: <span class="font-bold text-blue-400">${config.numTeams}</span></label><input id="num-teams-slider" type="range" min="2" max="8" value="${config.numTeams}" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer"></div><div><label class="block text-lg font-medium text-gray-300 mb-2">Membri per Team: <span class="font-bold text-blue-400">${config.membersPerTeam}</span></label><input id="members-per-team-slider" type="range" min="4" max="10" value="${config.membersPerTeam}" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer"></div></div><div class="mt-8 text-center"><button id="confirm-config-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg text-lg btn-glow">Vai alla Lobby</button></div></div>`; }
        function renderLobbyScreen() { const { players, config, hostId } = globalState.gameData; const isHost = globalState.userId === hostId; const canStart = Object.keys(players).length >= 2 && Object.keys(players).length === config.numTeams; let html = `<div class="w-full max-w-4xl mx-auto bg-gray-800 p-8 rounded-xl shadow-2xl"><h2 class="text-3xl font-bold text-center mb-2">Lobby di Gioco</h2><p class="text-center text-gray-400 mb-6">Codice Stanza: <span id="room-code" class="font-bold text-2xl text-yellow-400 tracking-widest cursor-pointer" title="Copia codice">${globalState.gameId}</span></p><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">`; for (let i = 0; i < config.numTeams; i++) { const playerId = Object.keys(players)[i]; const player = players[playerId]; if (player) { html += `<div class="bg-gray-700 p-4 rounded-lg text-center ${playerId === hostId ? 'border-2 border-yellow-400' : ''}"><p class="text-xl font-bold truncate">${player.nickname}</p><p class="text-sm ${player.isCPU ? 'text-cyan-400' : 'text-green-400'}">${player.isCPU ? 'CPU' : 'Giocatore'}</p></div>`; } else { html += `<div class="bg-gray-900 border-2 border-dashed border-gray-600 p-4 rounded-lg text-center text-gray-500 flex items-center justify-center"><p>In attesa...</p></div>`; } } html += `</div><div class="flex flex-col md:flex-row justify-between items-center mt-8"><button id="leave-game-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg text-lg mb-4 md:mb-0">Abbandona Stanza</button>${isHost ? `<div class="flex items-center space-x-4"><button id="add-cpu-btn" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-6 rounded-lg text-lg disabled:opacity-50 disabled:cursor-not-allowed" ${Object.keys(players).length >= config.numTeams ? 'disabled' : ''}>Aggiungi CPU</button><button id="start-game-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg text-lg disabled:opacity-50 disabled:cursor-not-allowed" ${!canStart ? 'disabled' : ''}>Inizia Partita</button></div>` : '<p class="text-lg">In attesa che l\'host inizi la partita...</p>'}</div></div>`; return html; }
        function renderDraftScreen() { const { draftState, players, config } = globalState.gameData; if (!draftState) return renderLoading(); const currentPlayerId = draftState.playerOrder[draftState.currentPlayerIndex]; const currentPlayer = players[currentPlayerId]; const isMyTurn = currentPlayerId === globalState.userId; const picksPerPlayer = players[globalState.userId]?.characters.length || 0; let html = `<style>
                .new-character-glow {
                    box-shadow: 0 0 15px rgba(239, 68, 68, 0.9), 0 0 5px rgba(255, 100, 100, 1) inset;
                    border-color: #ef4444;
                }
                .new-tag {
                    position: absolute;
                    top: -5px;
                    right: -5px;
                    background-color: #ef4444;
                    color: white;
                    font-size: 0.6rem;
                    font-weight: bold;
                    padding: 2px 5px;
                    border-radius: 5px;
                    transform: rotate(15deg);
                    text-transform: uppercase;
                    z-index: 10;
                }
            </style>
            <div class="w-full max-w-7xl mx-auto flex flex-col h-screen"><div class="p-4 bg-gray-800 rounded-t-xl shadow-lg"><h1 class="text-3xl font-black text-center">SELEZIONE PERSONAGGI</h1><p class="text-center text-lg text-yellow-400 mt-2">Turno di: <span class="font-bold text-white">${currentPlayer.nickname}</span> ${isMyTurn ? '(Tocca a te!)' : ''}</p><p class="text-center text-gray-400">Selezione ${draftState.picksMade + 1} di ${draftState.totalPicks}</p></div><div class="flex-grow overflow-y-auto p-4 bg-gray-800 bg-opacity-50"><div class="grid grid-cols-5 sm:grid-cols-6 md:grid-cols-8 lg:grid-cols-10 gap-3">`; charactersDB.forEach(char => { const isTaken = !draftState.availableCharacterIds.includes(char.id); const canSelect = isMyTurn && !isTaken && !currentPlayer.isCPU; const isNew = char.isNew || false; html += `<div data-character-id="${char.id}" class="character-card relative ${isTaken ? 'taken' : ''} ${canSelect ? 'selectable cursor-pointer' : ''} ${isNew ? 'new-character-glow' : ''}"><img src="${char.img}" alt="${char.name}" class="w-full h-auto rounded-md aspect-square object-cover" loading="lazy" onerror="this.onerror=null;this.src='https://placehold.co/100x100/1f2937/9ca3af?text=?';"> ${isNew ? '<div class="new-tag">Nuovo!</div>' : ''} <p class="text-xs text-center mt-1 truncate p-1 bg-black bg-opacity-50 rounded-b-md">${char.name}</p></div>`; }); html += `</div></div><div class="p-4 bg-gray-800 rounded-b-xl shadow-lg"><h3 class="text-lg font-bold text-center">Il tuo Team (${picksPerPlayer}/${config.membersPerTeam})</h3><div class="flex justify-center items-center space-x-2 mt-2 min-h-[60px]">`; const myTeamChars = players[globalState.userId].characters; if (myTeamChars.length > 0) { myTeamChars.forEach(charObj => { const charData = charactersDB.find(c => c.id === charObj.id); html += `<img src="${charData.img}" title="${charData.name}" class="w-12 h-12 rounded-full border-2 border-blue-400 object-cover">`; }); } else { html += `<p class="text-gray-500">Nessun personaggio selezionato.</p>`; } html += `</div></div></div>`; return html; }
        function renderNamingScreen() { const myPlayer = globalState.gameData.players[globalState.userId]; if (!myPlayer) return renderLoading(); if (myPlayer.ready) { return `<div class="text-center"><h1 class="text-3xl font-bold">In attesa degli altri giocatori...</h1><svg class="animate-spin h-8 w-8 text-white mx-auto mt-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>`; } const usedColors = Object.values(globalState.gameData.players).map(p => p.teamColor).filter(Boolean); return `<div class="w-full max-w-2xl mx-auto bg-gray-800 p-8 rounded-xl shadow-2xl text-center"><h1 class="text-4xl font-bold">Crea il tuo Team</h1><p class="text-xl mt-2 text-gray-400">Dai un nome e un colore alla tua squadra.</p><div class="mt-8"><label for="team-name-input" class="text-lg font-medium">Nome del Team</label><input type="text" id="team-name-input" class="w-full bg-gray-700 border-2 border-gray-600 rounded-lg p-3 text-center text-lg focus:outline-none focus:border-blue-500 mt-2" placeholder="Nome epico..." maxlength="20"></div><div class="mt-6"><label class="text-lg font-medium">Colore del Team</label><div class="grid grid-cols-8 gap-2 mt-2"> ${teamColors.map(color => { const isTaken = usedColors.includes(color.hex) && myPlayer.teamColor !== color.hex; return `<div data-color="${color.hex}" class="color-swatch w-full h-12 rounded-lg cursor-pointer ${isTaken ? 'taken' : ''}" style="background-color: ${color.hex};"></div>`; }).join('')}</div></div><button id="confirm-team-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg mt-8 text-lg btn-glow disabled:opacity-50" disabled>Sono Pronto</button></div>`; }
        function renderArenaScreen() {
            const { players, arenaState } = globalState.gameData;
            if (!arenaState) return renderLoading();
            
            const teamLeaderboard = Object.values(players).filter(p => !p.eliminated).sort((a, b) => b.characters.filter(c => c.status === 'active').length - a.characters.filter(c => c.status === 'active').length);
            const killsLeaderboard = Object.values(players).filter(p => p.kills > 0).sort((a, b) => b.kills - a.kills);

            let html = `<div class="w-full h-screen bg-arena p-4 overflow-y-auto relative">
                <div class="absolute top-4 right-4 w-64 space-y-4 z-10">
                    <div class="bg-black bg-opacity-70 p-3 rounded-lg">
                        <h3 class="font-bold text-yellow-400 text-center mb-2">Team in Gara</h3>
                        <ul class="space-y-1 text-sm">${teamLeaderboard.map(p => `<li class="flex justify-between"><span class="font-semibold truncate" style="color:${p.teamColor};">${p.teamName}</span> <span>${p.characters.filter(c => c.status === 'active').length} membri</span></li>`).join('')}</ul>
                    </div>
                    <div class="bg-black bg-opacity-70 p-3 rounded-lg">
                        <h3 class="font-bold text-red-500 text-center mb-2">Migliori Uccisori</h3>
                        <ul class="space-y-1 text-sm">${killsLeaderboard.length > 0 ? killsLeaderboard.map(p => `<li class="flex justify-between"><span class="font-semibold truncate" style="color:${p.teamColor};">${p.nickname}</span> <span>${p.kills} Kills</span></li>`).join('') : '<li class="text-center text-gray-400">Nessuna</li>'}</ul>
                    </div>
                </div>
                
                <h1 class="text-5xl font-black text-center text-shadow mb-4">ROUND ${arenaState.round}</h1>
                <p class="text-center text-yellow-400 text-xl mb-8">${arenaState.log[arenaState.log.length - 1]}</p>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">`;

            for (const playerId in players) {
                const player = players[playerId];
                if(player.eliminated) continue;
                const isFighting = arenaState.fightingTeams && arenaState.fightingTeams.includes(playerId);
                const activeChars = player.characters.filter(c => c.status === 'active');
                const defeatedChars = player.characters.filter(c => c.status === 'defeated');

                html += `<div class="bg-black bg-opacity-70 rounded-lg p-4 border-2 ${isFighting ? 'fighting-team' : 'border-transparent'}" style="border-color: ${isFighting ? '#facc15' : player.teamColor};">
                                <h2 class="text-2xl font-bold truncate" style="color: ${player.teamColor}; text-shadow: 0 0 5px ${player.teamColor};">${player.teamName}</h2>
                                <p class="text-sm text-gray-300 mb-3">${player.nickname}</p>
                                <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-2">
                                    ${[...activeChars, ...defeatedChars].map(charObj => {
                                        const charData = charactersDB.find(c => c.id === charObj.id);
                                        const isDefeated = charObj.status === 'defeated';
                                        return `<div class="text-center">
                                                    <img src="${charData.img}" title="${charData.name}" class="w-16 h-16 rounded-full border-2 object-cover mx-auto ${isDefeated ? 'character-icon defeated' : ''}" style="border-color: ${player.teamColor};">
                                                    <p class="text-xs truncate mt-1 ${isDefeated ? 'text-gray-500' : ''}">${charData.name}</p>
                                                </div>`;
                                    }).join('')}
                                </div></div>`;
            }
            html += `</div>`;

            if (arenaState.status === 'revealing_teams') html += renderTeamRevealOverlay();
            else if (arenaState.status === 'selecting_fighters' && arenaState.fightingTeams.includes(globalState.userId) && !arenaState.currentFighters[globalState.userId]) html += renderFighterSelectionOverlay();
            else if (arenaState.status === 'fighting_dice') html += renderDiceFightOverlay();
            else if (arenaState.status === 'fighting_rpg') html += renderRPGFightOverlay();

            html += `</div>`;
            return html;
        }

        function renderTeamRevealOverlay() { return `<div class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-40 fade-in"><div class="text-center"><h2 class="text-4xl font-black text-yellow-300 animate-pulse">Il fato sta scegliendo...</h2><p class="text-xl text-gray-300 mt-4">Chi si scontrerà nel prossimo round?</p></div></div>`; }
        function renderFighterSelectionOverlay() { const myTeam = globalState.gameData.players[globalState.userId]; return `<div class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-40"><div class="bg-gray-800 p-8 rounded-xl shadow-2xl text-center w-full max-w-3xl"><h2 class="text-3xl font-bold text-yellow-400">Scegli il tuo combattente!</h2><p class="text-gray-300 my-4">Il tuo team è stato scelto per combattere. Seleziona un personaggio da mandare in arena.</p><div class="grid grid-cols-3 md:grid-cols-5 gap-4 mt-6">${myTeam.characters.filter(c => c.status === 'active').map(charObj => { const charData = charactersDB.find(c => c.id === charObj.id); return `<div data-character-id="${charObj.id}" class="character-card selectable cursor-pointer"><img src="${charData.img}" alt="${charData.name}" class="w-full h-auto rounded-md aspect-square object-cover"><p class="text-sm text-center mt-2 font-semibold">${charData.name}</p></div>`; }).join('')}</div></div></div>`; }
        function renderDiceFightOverlay() {
            const { arenaState, players } = globalState.gameData;
            const [player1Id, player2Id] = arenaState.fightingTeams;
            const fighter1 = charactersDB.find(c => c.id === arenaState.currentFighters[player1Id]);
            const fighter2 = charactersDB.find(c => c.id === arenaState.currentFighters[player2Id]);
            if (!fighter1 || !fighter2) return '<div class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-40"><p>In attesa della selezione...</p></div>';
            const team1 = players[player1Id]; const team2 = players[player2Id]; const myTurn = arenaState.diceTurn === globalState.userId;
            
            let hostControls = '';
            if (globalState.userId === globalState.gameData.hostId && arenaState.diceRolls[arenaState.diceTurn] === null) {
                hostControls = `<button id="force-dice-roll-btn" class="absolute top-4 left-4 bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg z-50" title="Forza il lancio del dado per il giocatore attuale">Forza Lancio</button>`;
            }

            return `<div class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-40"><div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-4xl relative">
                        ${hostControls}
                        <h2 class="text-3xl font-bold text-center text-red-500 mb-6">SCONTRO AI DADI!</h2><div class="flex justify-around items-center text-center"><div class="flex flex-col items-center"><img src="${fighter1.img}" class="w-40 h-40 rounded-full border-4 object-cover" style="border-color:${team1.teamColor};"><h3 class="text-2xl font-bold mt-2">${fighter1.name}</h3><p class="text-lg" style="color:${team1.teamColor};">${team1.teamName}</p><div class="text-6xl font-black mt-4 h-20 flex items-center justify-center ${arenaState.diceRolls[player1Id] ? 'dice' : ''}">${arenaState.diceRolls[player1Id] || '?'}</div></div><div class="text-5xl font-black text-gray-500">VS</div><div class="flex flex-col items-center"><img src="${fighter2.img}" class="w-40 h-40 rounded-full border-4 object-cover" style="border-color:${team2.teamColor};"><h3 class="text-2xl font-bold mt-2">${fighter2.name}</h3><p class="text-lg" style="color:${team2.teamColor};">${team2.teamName}</p><div class="text-6xl font-black mt-4 h-20 flex items-center justify-center ${arenaState.diceRolls[player2Id] ? 'dice' : ''}">${arenaState.diceRolls[player2Id] || '?'}</div></div></div><div class="text-center mt-8">${myTurn ? `<button id="roll-dice-btn" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-4 px-10 rounded-lg text-xl btn-glow">Lancia il Dado!</button>` : `<p class="text-xl">In attesa del lancio di ${players[arenaState.diceTurn].nickname}...</p>`}</div></div></div>`;
        }
        function getHPColor(percent) {
            if (percent > 50) return 'bg-green-500';
            if (percent > 25) return 'bg-yellow-500';
            return 'bg-red-500';
        }
        function renderStatusBadge(status) {
            if (!status) return '';
            const statusInfo = {
                poison: { text: 'AVV', color: 'bg-purple-600', full: 'Avvelenato' },
                burn: { text: 'SCO', color: 'bg-orange-600', full: 'Scottato' },
                freeze: { text: 'CON', color: 'bg-cyan-500', full: 'Congelato' },
                stun: { text: 'STN', color: 'bg-yellow-500', full: 'Stordito' },
                infatuation: { text: 'INF', color: 'bg-pink-500', full: 'Infatuato' },
                sleep: { text: 'SLP', color: 'bg-gray-400', full: 'Addormentato' },
                vortex: { text: 'VOR', color: 'bg-blue-700', full: 'Intrappolato' },
                invulnerability: { text: 'INV', color: 'bg-white text-black', full: 'Invulnerabile' }
            };
            const info = statusInfo[status.type];
            if (!info) return '';
            return `<span class="status-badge ${info.color}" title="${info.full} (${status.duration} turni)">${info.text}</span>`;
        }
        function renderRPGFightOverlay() {
            const { arenaState, players } = globalState.gameData;
            const { rpgBattle } = arenaState;
            if (!rpgBattle) return '';

            const p1Id = rpgBattle.p1_id;
            const p2Id = rpgBattle.p2_id;
            const fighter1 = charactersDB.find(c => c.id === arenaState.currentFighters[p1Id]);
            const fighter2 = charactersDB.find(c => c.id === arenaState.currentFighters[p2Id]);
            
            const myTurn = rpgBattle.turn === globalState.userId;
            const amFighting = arenaState.fightingTeams.includes(globalState.userId);
            const myChar = globalState.userId === p1Id ? fighter1 : (globalState.userId === p2Id ? fighter2 : null);
            const myPlayer = players[globalState.userId];
            const myCharInGame = myChar ? myPlayer?.characters.find(c => c.id === myChar.id) : null;

            const hp1Percent = (rpgBattle.p1_hp / rpgBattle.p1_max_hp) * 100;
            const hp2Percent = (rpgBattle.p2_hp / rpgBattle.p2_max_hp) * 100;
            const hp1Color = getHPColor(hp1Percent);
            const hp2Color = getHPColor(hp2Percent);
            
            let bottomSection;
            if (myTurn && rpgBattle.phase === 'action') {
                bottomSection = `<div class="grid grid-cols-2 gap-3 mt-4">
                    ${myChar.moves.map((move, index) => {
                        const hasUses = move.uses !== undefined;
                        const usesLeft = hasUses ? (myCharInGame.specialUses[index] ?? move.uses) : -1;
                        const isDisabled = hasUses && usesLeft <= 0;
                        return `<button data-move-index="${index}" title="${move.description}" class="rpg-move-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg text-sm btn-glow disabled:opacity-50 disabled:cursor-not-allowed" ${isDisabled ? 'disabled' : ''}>
                                    ${move.name} ${hasUses ? `(${usesLeft}/${move.uses})` : ''}
                                </button>`;
                    }).join('')}
                </div>`;
            } else if (amFighting) {
                bottomSection = `<p class="text-center text-xl mt-4">In attesa di ${players[rpgBattle.turn].nickname}...</p>`;
            } else {
                bottomSection = `<p class="text-center text-xl mt-4">Modalità Spettatore: Osservando lo scontro...</p>`;
            }

            return `<div class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-40">
                <div class="bg-gray-800 p-6 rounded-xl shadow-2xl w-full max-w-6xl relative">
                    <h2 class="text-3xl font-bold text-center text-purple-400 mb-4">BATTAGLIA RPG!</h2>
                    <div class="grid grid-cols-2 gap-8 items-start">
                        <div class="text-center ${rpgBattle.turn === p1Id ? 'turn-highlight rounded-lg' : ''} p-4 relative">
                            <img src="${fighter1.img}" class="w-48 h-48 rounded-full border-4 object-cover mx-auto" style="border-color:${players[p1Id].teamColor};">
                            <div class="absolute top-4 right-4">${renderStatusBadge(rpgBattle.p1_status)}</div>
                            <h3 class="text-2xl font-bold mt-2">${fighter1.name}</h3>
                            <div class="w-full bg-gray-600 rounded-full h-6 mt-2 border-2 border-gray-500"><div class="${hp1Color} h-full rounded-full hp-bar-inner" style="width: ${hp1Percent}%;"></div></div>
                            <p class="font-bold text-lg">${rpgBattle.p1_hp} / ${rpgBattle.p1_max_hp} HP</p>
                        </div>
                        <div class="text-center ${rpgBattle.turn === p2Id ? 'turn-highlight rounded-lg' : ''} p-4 relative">
                            <img src="${fighter2.img}" class="w-48 h-48 rounded-full border-4 object-cover mx-auto" style="border-color:${players[p2Id].teamColor};">
                            <div class="absolute top-4 right-4">${renderStatusBadge(rpgBattle.p2_status)}</div>
                            <h3 class="text-2xl font-bold mt-2">${fighter2.name}</h3>
                            <div class="w-full bg-gray-600 rounded-full h-6 mt-2 border-2 border-gray-500"><div class="${hp2Color} h-full rounded-full hp-bar-inner" style="width: ${hp2Percent}%;"></div></div>
                            <p class="font-bold text-lg">${rpgBattle.p2_hp} / ${rpgBattle.p2_max_hp} HP</p>
                        </div>
                    </div>
                    <div class="mt-4 border-t border-gray-600 pt-4">
                        <p class="text-center text-lg text-yellow-300 h-8">${rpgBattle.battleLog[rpgBattle.battleLog.length - 1] || ''}</p>
                        ${bottomSection}
                    </div>
                </div>
            </div>`;
        }
        function renderFinishedScreen() {
            const { players } = globalState.gameData;
            
            const winner = Object.values(players).find(p => !p.eliminated);
            const losers = Object.values(players).filter(p => p.eliminated).sort((a, b) => b.eliminatedInRound - a.eliminatedInRound);
            const teamRanking = winner ? [winner, ...losers] : losers;

            const killsRanking = Object.values(players).filter(p => p.kills > 0).sort((a, b) => b.kills - a.kills);

            return `<div class="w-full max-w-4xl mx-auto bg-gray-800 p-8 rounded-xl shadow-2xl fade-in">
                            <h1 class="text-5xl font-black text-center text-yellow-400">IL TORNEO È CONCLUSO!</h1>
                            ${winner ? `<p class="text-2xl text-center mt-2">Il team <span class="font-bold" style="color:${winner.teamColor};">${winner.teamName}</span> è il vincitore!</p>` : ''}
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-10">
                                <div>
                                    <h2 class="text-2xl font-bold text-center mb-4">Classifica Team</h2>
                                    <ol class="space-y-2">
                                        ${teamRanking.map((p, index) => `
                                            <li class="flex items-center bg-gray-700 p-3 rounded-lg">
                                                <span class="text-2xl font-bold w-8">${index + 1}</span>
                                                <div class="w-4 h-4 rounded-full mr-3" style="background-color:${p.teamColor};"></div>
                                                <div>
                                                    <p class="font-bold text-lg">${p.teamName}</p>
                                                    <p class="text-sm text-gray-400">Leader: ${p.nickname}</p>
                                                </div>
                                            </li>
                                        `).join('')}
                                    </ol>
                                </div>
                                <div>
                                    <h2 class="text-2xl font-bold text-center mb-4">Top Eliminazioni</h2>
                                    <ul class="space-y-2">
                                         ${killsRanking.length > 0 ? killsRanking.map((p, index) => `
                                            <li class="flex items-center bg-gray-700 p-2 rounded-lg">
                                                <span class="text-xl font-bold w-8">${index + 1}</span>
                                                <div>
                                                    <p class="font-bold text-lg" style="color:${p.teamColor};">${p.nickname}</p>
                                                </div>
                                                <span class="ml-auto font-bold text-lg">${p.kills} Kills</span>
                                            </li>
                                         `).join('') : '<li class="text-center text-gray-400">Nessuna eliminazione.</li>'}
                                    </ul>
                                </div>
                            </div>

                            <div class="text-center mt-10">
                                <button id="leave-game-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg text-lg btn-glow">Torna al Menu</button>
                            </div>
                        </div>`;
        }


        // --- GESTIONE EVENTI ---
        function attachEventListeners() {
            document.getElementById('nickname-form')?.addEventListener('submit', (e) => { e.preventDefault(); const nickname = document.getElementById('nickname-input').value.trim(); if (nickname) { globalState.nickname = nickname; localStorage.setItem('battagliaRoyaleNickname', nickname); globalState.currentScreen = 'menu'; render(); } });
            document.getElementById('create-game-btn')?.addEventListener('click', createGame);
            document.getElementById('join-game-btn')?.addEventListener('click', () => { const code = document.getElementById('join-code-input').value.trim().toUpperCase(); if (code) joinGame(code); else { globalState.error = "Inserisci un codice valido."; render(); } });
            document.getElementById('num-teams-slider')?.addEventListener('input', e => updateDoc(doc(db, `artifacts/${appId}/public/data/battaglia-royale`, globalState.gameId), { 'config.numTeams': parseInt(e.target.value) }));
            document.getElementById('members-per-team-slider')?.addEventListener('input', e => updateDoc(doc(db, `artifacts/${appId}/public/data/battaglia-royale`, globalState.gameId), { 'config.membersPerTeam': parseInt(e.target.value) }));
            document.getElementById('confirm-config-btn')?.addEventListener('click', () => updateDoc(doc(db, `artifacts/${appId}/public/data/battaglia-royale`, globalState.gameId), { status: 'waiting' }));
            document.getElementById('leave-game-btn')?.addEventListener('click', leaveGame);
            document.getElementById('add-cpu-btn')?.addEventListener('click', async () => { const cpuId = `CPU_${generateRoomCode()}`; const cpuNames = ["Terminator", "Skynet", "HAL9000", "Matrix", "Ultron", "Agent Smith"]; const cpuNickname = cpuNames[Math.floor(Math.random() * cpuNames.length)]; const playerUpdate = { [`players.${cpuId}`]: { nickname: cpuNickname, isCPU: true, teamName: '', teamColor: null, characters: [], eliminated: false, kills: 0, ready: false, eliminatedInRound: null } }; await updateDoc(doc(db, `artifacts/${appId}/public/data/battaglia-royale`, globalState.gameId), playerUpdate); });
            document.getElementById('start-game-btn')?.addEventListener('click', initializeDraft);
            document.getElementById('room-code')?.addEventListener('click', (e) => { navigator.clipboard.writeText(e.target.innerText).then(() => { globalState.error = "Codice copiato!"; render(); }); });

            if (globalState.currentScreen === 'drafting') { document.querySelectorAll('.character-card.selectable').forEach(card => { card.addEventListener('click', () => { const charId = parseInt(card.dataset.characterId); selectCharacter(charId); }); }); }
            if (globalState.currentScreen === 'naming' && !globalState.gameData.players[globalState.userId].ready) {
                const nameInput = document.getElementById('team-name-input');
                const confirmBtn = document.getElementById('confirm-team-btn');
                let selectedColor = null;
                document.querySelectorAll('.color-swatch:not(.taken)').forEach(swatch => {
                    swatch.addEventListener('click', () => {
                        document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('selected'));
                        swatch.classList.add('selected');
                        selectedColor = swatch.dataset.color;
                        if (nameInput.value.trim().length > 2) confirmBtn.disabled = false;
                    });
                });
                nameInput.addEventListener('input', () => { confirmBtn.disabled = !(nameInput.value.trim().length > 2 && selectedColor); });
                confirmBtn.addEventListener('click', async () => {
                    const teamName = nameInput.value.trim();
                    if (teamName && selectedColor) {
                        confirmBtn.disabled = true;
                        await updateDoc(doc(db, `artifacts/${appId}/public/data/battaglia-royale`, globalState.gameId), { [`players.${globalState.userId}.teamName`]: teamName, [`players.${globalState.userId}.teamColor`]: selectedColor, [`players.${globalState.userId}.ready`]: true, });
                    }
                });
            }
            if (globalState.currentScreen === 'fighting') {
                document.querySelectorAll('.character-card.selectable').forEach(card => { card.addEventListener('click', () => { const charId = parseInt(card.dataset.characterId); selectFighter(charId); }); });
                document.getElementById('roll-dice-btn')?.addEventListener('click', rollDice);
                document.querySelectorAll('.rpg-move-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const moveIndex = parseInt(btn.dataset.moveIndex);
                        handlePlayerMove(moveIndex);
                    });
                });
                document.getElementById('force-round-end-btn')?.addEventListener('click', forceNextAction);
            }
        }

        render();

    </script>
</body>
</html>
